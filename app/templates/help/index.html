{% extends "base.html" %}

{% block title %}Help Center - Sentia Manufacturing Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Help Center Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-body text-center py-5">
                    <h1 class="display-4 mb-3">Help Center</h1>
                    <p class="lead">Find answers, learn new features, and get support</p>
                    
                    <!-- Search Bar -->
                    <div class="row justify-content-center mt-4">
                        <div class="col-md-8 col-lg-6">
                            <form action="{{ url_for('help.search') }}" method="GET" id="help-search-form">
                                <div class="input-group input-group-lg">
                                    <input type="text" class="form-control" name="q" 
                                           placeholder="Search help articles..." id="help-search-input"
                                           autocomplete="off">
                                    <button class="btn btn-light" type="submit">
                                        <i class="fas fa-search"></i> Search
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Search Suggestions -->
                    <div id="search-suggestions" class="mt-3" style="display: none;">
                        <div class="row justify-content-center">
                            <div class="col-md-8 col-lg-6">
                                <div class="card">
                                    <div class="list-group list-group-flush" id="suggestions-list">
                                        <!-- Dynamic suggestions will be inserted here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-graduation-cap fa-3x text-primary mb-3"></i>
                    <h5>Interactive Tutorials</h5>
                    <p class="text-muted">Step-by-step guided learning</p>
                    <a href="{{ url_for('help.tutorials') }}" class="btn btn-primary">Start Learning</a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-book fa-3x text-success mb-3"></i>
                    <h5>User Manual</h5>
                    <p class="text-muted">Comprehensive documentation</p>
                    <a href="/docs/user-guide/user-manual.html" target="_blank" class="btn btn-success">View Manual</a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-video fa-3x text-info mb-3"></i>
                    <h5>Video Tutorials</h5>
                    <p class="text-muted">Watch and learn</p>
                    <a href="#" class="btn btn-info">Watch Videos</a>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-life-ring fa-3x text-warning mb-3"></i>
                    <h5>Get Support</h5>
                    <p class="text-muted">Contact our support team</p>
                    <a href="{{ url_for('help.support') }}" class="btn btn-warning">Contact Support</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Popular Articles and Categories -->
    <div class="row">
        <!-- Categories -->
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-folder"></i> Browse by Category</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="{{ url_for('help.search', category='getting_started') }}" 
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-play-circle text-primary"></i> Getting Started</span>
                        <span class="badge bg-primary rounded-pill">12</span>
                    </a>
                    <a href="{{ url_for('help.search', category='forecasting') }}" 
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-chart-line text-success"></i> Demand Forecasting</span>
                        <span class="badge bg-success rounded-pill">18</span>
                    </a>
                    <a href="{{ url_for('help.search', category='inventory') }}" 
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-boxes text-info"></i> Inventory Management</span>
                        <span class="badge bg-info rounded-pill">15</span>
                    </a>
                    <a href="{{ url_for('help.search', category='production') }}" 
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-industry text-warning"></i> Production Planning</span>
                        <span class="badge bg-warning rounded-pill">11</span>
                    </a>
                    <a href="{{ url_for('help.search', category='integrations') }}" 
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-plug text-danger"></i> API Integrations</span>
                        <span class="badge bg-danger rounded-pill">8</span>
                    </a>
                    <a href="{{ url_for('help.search', category='troubleshooting') }}" 
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-wrench text-secondary"></i> Troubleshooting</span>
                        <span class="badge bg-secondary rounded-pill">9</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Popular Articles -->
        <div class="col-md-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-star"></i> Popular Articles</h5>
                </div>
                <div class="card-body">
                    {% if popular_articles %}
                        <div class="row">
                            {% for article in popular_articles %}
                            <div class="col-md-6 mb-3">
                                <div class="card h-100 border-0 shadow-sm">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <a href="{{ url_for('help.view_article', slug=article.slug) }}" 
                                               class="text-decoration-none">{{ article.title }}</a>
                                        </h6>
                                        <p class="card-text text-muted small">{{ article.summary[:100] }}...</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                <i class="fas fa-eye"></i> {{ article.view_count }} views
                                            </small>
                                            <small class="text-success">
                                                <i class="fas fa-thumbs-up"></i> {{ article.helpful_votes }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No articles available yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Tutorial Progress -->
    {% if tutorials %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-graduation-cap"></i> Your Learning Progress</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for tutorial in tutorials %}
                        <div class="col-md-4 mb-3">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <h6 class="card-title">{{ tutorial.title }}</h6>
                                    <p class="card-text text-muted small">{{ tutorial.description }}</p>
                                    
                                    <!-- Progress Bar -->
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between">
                                            <small>Progress</small>
                                            <small>{{ tutorial.progress.progress_percentage|int }}%</small>
                                        </div>
                                        <div class="progress" style="height: 6px;">
                                            <div class="progress-bar 
                                                {% if tutorial.progress.status == 'completed' %}bg-success
                                                {% elif tutorial.progress.status == 'in_progress' %}bg-primary
                                                {% else %}bg-secondary{% endif %}" 
                                                 style="width: {{ tutorial.progress.progress_percentage }}%"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Action Button -->
                                    {% if tutorial.progress.status == 'completed' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> Completed
                                        </span>
                                    {% elif tutorial.progress.status == 'in_progress' %}
                                        <a href="{{ url_for('help.view_tutorial', tutorial_id=tutorial.id) }}" 
                                           class="btn btn-primary btn-sm">Continue</a>
                                    {% else %}
                                        <a href="{{ url_for('help.view_tutorial', tutorial_id=tutorial.id) }}" 
                                           class="btn btn-outline-primary btn-sm">Start Tutorial</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Quick Help Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-question-circle"></i> Frequently Asked Questions</h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="faqAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#faq1">
                                    How do I generate my first forecast?
                                </button>
                            </h2>
                            <div id="faq1" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    Go to the Forecasting module, select your products and time horizon, 
                                    choose a forecasting method, and click Generate. 
                                    <a href="{{ url_for('help.view_article', slug='generating-first-forecast') }}">Learn more</a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#faq2">
                                    Why are my stock levels showing as critical?
                                </button>
                            </h2>
                            <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    Critical stock alerts appear when inventory falls below your reorder point. 
                                    Check your safety stock settings and lead times.
                                    <a href="{{ url_for('help.view_article', slug='understanding-stock-alerts') }}">Learn more</a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#faq3">
                                    How do I connect my Amazon account?
                                </button>
                            </h2>
                            <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                                <div class="accordion-body">
                                    Go to Admin > Integrations > Amazon SP-API and follow the setup wizard. 
                                    You'll need your Amazon Developer Console credentials.
                                    <a href="{{ url_for('help.view_article', slug='amazon-integration-setup') }}">Learn more</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-headset"></i> Need More Help?</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <i class="fas fa-ticket-alt fa-2x text-primary mb-2"></i>
                            <h6>Submit a Ticket</h6>
                            <p class="text-muted small">Get help from our support team</p>
                            <a href="{{ url_for('help.new_support_ticket') }}" class="btn btn-primary btn-sm">
                                Create Ticket
                            </a>
                        </div>
                        <div class="col-6 mb-3">
                            <i class="fas fa-comments fa-2x text-success mb-2"></i>
                            <h6>Live Chat</h6>
                            <p class="text-muted small">Chat with us in real-time</p>
                            <button class="btn btn-success btn-sm" onclick="startLiveChat()">
                                Start Chat
                            </button>
                        </div>
                        <div class="col-6">
                            <i class="fas fa-envelope fa-2x text-info mb-2"></i>
                            <h6>Email Support</h6>
                            <p class="text-muted small">support@sentia-manufacturing.com</p>
                            <a href="mailto:support@sentia-manufacturing.com" class="btn btn-info btn-sm">
                                Send Email
                            </a>
                        </div>
                        <div class="col-6">
                            <i class="fas fa-phone fa-2x text-warning mb-2"></i>
                            <h6>Phone Support</h6>
                            <p class="text-muted small">Emergency support only</p>
                            <a href="tel:+1-800-SENTIA" class="btn btn-warning btn-sm">
                                Call Now
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Live Chat Widget (Hidden by default) -->
<div id="live-chat-widget" class="position-fixed bottom-0 end-0 m-3" style="display: none; z-index: 1050;">
    <div class="card shadow" style="width: 350px;">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="fas fa-comments"></i> Live Support</h6>
            <button class="btn btn-sm btn-outline-light" onclick="closeLiveChat()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="card-body" style="height: 300px; overflow-y: auto;" id="chat-messages">
            <div class="mb-2">
                <div class="bg-light p-2 rounded">
                    <small class="text-muted">Support Agent</small><br>
                    Hi! How can I help you today?
                </div>
            </div>
        </div>
        <div class="card-footer">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Type your message..." id="chat-input">
                <button class="btn btn-primary" onclick="sendChatMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Search functionality
document.getElementById('help-search-input').addEventListener('input', function(e) {
    const query = e.target.value.trim();
    if (query.length >= 2) {
        searchSuggestions(query);
    } else {
        document.getElementById('search-suggestions').style.display = 'none';
    }
});

function searchSuggestions(query) {
    fetch(`/help/api/search?q=${encodeURIComponent(query)}&limit=5`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data.articles.length > 0) {
                showSuggestions(data.data.articles);
            } else {
                document.getElementById('search-suggestions').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Search suggestions error:', error);
        });
}

function showSuggestions(articles) {
    const suggestionsList = document.getElementById('suggestions-list');
    suggestionsList.innerHTML = '';
    
    articles.forEach(article => {
        const listItem = document.createElement('a');
        listItem.className = 'list-group-item list-group-item-action';
        listItem.href = `/help/article/${article.slug}`;
        listItem.innerHTML = `
            <div class="d-flex justify-content-between">
                <div>
                    <h6 class="mb-1">${article.title}</h6>
                    <small class="text-muted">${article.summary || 'No summary available'}</small>
                </div>
                <small class="text-muted">${article.category}</small>
            </div>
        `;
        suggestionsList.appendChild(listItem);
    });
    
    document.getElementById('search-suggestions').style.display = 'block';
}

// Hide suggestions when clicking outside
document.addEventListener('click', function(e) {
    if (!document.getElementById('help-search-form').contains(e.target)) {
        document.getElementById('search-suggestions').style.display = 'none';
    }
});

// Live Chat functionality
function startLiveChat() {
    document.getElementById('live-chat-widget').style.display = 'block';
}

function closeLiveChat() {
    document.getElementById('live-chat-widget').style.display = 'none';
}

function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (message) {
        const messagesContainer = document.getElementById('chat-messages');
        
        // Add user message
        const userMessage = document.createElement('div');
        userMessage.className = 'mb-2 text-end';
        userMessage.innerHTML = `
            <div class="bg-primary text-white p-2 rounded d-inline-block">
                ${message}
            </div>
        `;
        messagesContainer.appendChild(userMessage);
        
        // Simulate agent response (replace with real chat integration)
        setTimeout(() => {
            const agentResponse = document.createElement('div');
            agentResponse.className = 'mb-2';
            agentResponse.innerHTML = `
                <div class="bg-light p-2 rounded">
                    <small class="text-muted">Support Agent</small><br>
                    Thank you for your message. A support agent will respond shortly.
                </div>
            `;
            messagesContainer.appendChild(agentResponse);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 1000);
        
        input.value = '';
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
}

// Allow Enter key to send chat message
document.getElementById('chat-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendChatMessage();
    }
});
</script>
{% endblock %}