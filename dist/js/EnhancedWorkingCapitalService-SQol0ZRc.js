class e{constructor(){this.apiBaseUrl="https://sentia-manufacturing-production.onrender.com/api",this.refreshInterval=3e5,this.cache=new Map,this.cacheTimestamps=new Map}async calculateWorkingCapitalRequirements(e={}){const{period:t=12,currency:a="GBP",includeForecasts:i=!0}=e;try{const[e,n,r,s,c]=await Promise.all([this.fetchAccountsReceivable(t),this.fetchInventoryData(t),this.fetchAccountsPayable(t),this.fetchCashFlowData(t),this.fetchSalesData(t)]),o={cash:s.currentCash||0,accountsReceivable:e.totalOutstanding||0,inventory:n.totalValue||0,prepaidExpenses:await this.fetchPrepaidExpenses()||0,otherCurrentAssets:await this.fetchOtherCurrentAssets()||0},l={accountsPayable:r.totalPayable||0,shortTermDebt:await this.fetchShortTermDebt()||0,accruedExpenses:await this.fetchAccruedExpenses()||0,taxesPayable:await this.fetchTaxesPayable()||0,otherCurrentLiabilities:await this.fetchOtherCurrentLiabilities()||0},h=Object.values(o).reduce((e,t)=>e+t,0),u=Object.values(l).reduce((e,t)=>e+t,0),y=h-u,p=u>0?h/u:0,g=u>0?(h-o.inventory-o.prepaidExpenses)/u:0,m=u>0?o.cash/u:0,d=c.annualRevenue||0,C=c.annualCOGS||.65*d,f=d>0?365*o.accountsReceivable/d:0,v=C>0?365*o.inventory/C:0,w=C>0?365*l.accountsPayable/C:0,k=f+v-w,R=d>0&&y>0?d/y:0,b=h>0?d/h:0,S={currentRatio:{target:1.5,good:1.8,excellent:2},quickRatio:{target:1,good:1.2,excellent:1.5},cashConversionCycle:{target:45,good:35,excellent:25},workingCapitalTurnover:{target:6,good:8,excellent:10}},D=await this.calculateRequirementsByCategory({currentAssets:o,currentLiabilities:l,salesData:c,period:t}),O=this.generateOptimizationRecommendations({currentRatio:p,quickRatio:g,cashConversionCycle:k,workingCapitalTurnover:R,benchmarks:S,requirements:D});let x=null;return i&&(x=await this.generateWorkingCapitalForecasts({workingCapital:y,currentAssets:o,currentLiabilities:l,salesData:c,period:12})),{calculationDate:(new Date).toISOString(),currency:a,period:t,currentAssets:o,currentLiabilities:l,workingCapital:{total:y,percentage:d>0?y/d*100:0,perEmployee:D.employeeCount>0?y/D.employeeCount:0},ratios:{current:p,quick:g,cash:m,workingCapitalTurnover:R,assetTurnover:b},cashConversionCycle:{total:k,components:{daysReceivableOutstanding:f,daysInventoryOutstanding:v,daysPayableOutstanding:w}},requirements:D,benchmarks:S,recommendations:O,forecasts:x,performanceScore:this.calculatePerformanceScore({currentRatio:p,quickRatio:g,cashConversionCycle:k,workingCapitalTurnover:R,benchmarks:S}),riskAssessment:this.assessWorkingCapitalRisk({workingCapital:y,ratios:{current:p,quick:g},cashConversionCycle:k,forecasts:x})}}catch(n){throw new Error(`Working capital calculation failed: ${n.message}`)}}async fetchAccountsReceivable(e){const t=`ar_${e}`;if(this.isValidCache(t))return this.cache.get(t);try{const a=await fetch(`${this.apiBaseUrl}/financial/accounts-receivable?period=${e}`);if(a.ok){const e=await a.json();return this.setCache(t,e),e}}catch(n){}const a=await this.fetchSalesData(e),i={totalOutstanding:1.5*a.monthlyAverage,aged30Days:.8*a.monthlyAverage,aged60Days:.5*a.monthlyAverage,aged90Plus:.2*a.monthlyAverage,currency:"GBP"};return this.setCache(t,i),i}async fetchInventoryData(e){const t=`inventory_${e}`;if(this.isValidCache(t))return this.cache.get(t);try{const a=await fetch(`${this.apiBaseUrl}/inventory/valuation?period=${e}`);if(a.ok){const e=await a.json();return this.setCache(t,e),e}}catch(n){}const a=await this.fetchSalesData(e),i={totalValue:.15*a.annualCOGS,rawMaterials:.06*a.annualCOGS,workInProcess:.04*a.annualCOGS,finishedGoods:.05*a.annualCOGS,currency:"GBP"};return this.setCache(t,i),i}async fetchAccountsPayable(e){const t=`ap_${e}`;if(this.isValidCache(t))return this.cache.get(t);try{const a=await fetch(`${this.apiBaseUrl}/financial/accounts-payable?period=${e}`);if(a.ok){const e=await a.json();return this.setCache(t,e),e}}catch(n){}const a=await this.fetchSalesData(e),i={totalPayable:.12*a.annualCOGS,aged30Days:.08*a.annualCOGS,aged60Days:.03*a.annualCOGS,aged90Plus:.01*a.annualCOGS,currency:"GBP"};return this.setCache(t,i),i}async fetchCashFlowData(e){const t=`cashflow_${e}`;if(this.isValidCache(t))return this.cache.get(t);try{const a=await fetch(`${this.apiBaseUrl}/financial/cash-flow?period=${e}`);if(a.ok){const e=await a.json();return this.setCache(t,e),e}}catch(n){}const a=await this.fetchSalesData(e),i={currentCash:2*a.monthlyAverage,operatingCashFlow:.15*a.monthlyAverage,freeCashFlow:.08*a.monthlyAverage,currency:"GBP"};return this.setCache(t,i),i}async fetchSalesData(e){const t=`sales_${e}`;if(this.isValidCache(t))return this.cache.get(t);try{const a=await fetch(`${this.apiBaseUrl}/financial/sales-data?period=${e}`);if(a.ok){const e=await a.json();return this.setCache(t,e),e}}catch(i){}const a={annualRevenue:4e7,annualCOGS:26e6,monthlyAverage:3333333,growthRate:.08,seasonality:.15,currency:"GBP"};return this.setCache(t,a),a}async calculateRequirementsByCategory(e){const{currentAssets:t,currentLiabilities:a,salesData:i,period:n}=e,r=await this.fetchEmployeeCount(),s=await this.fetchFacilityCount();return{operational:{description:"Day-to-day operations funding",amount:.25*i.monthlyAverage,daysOfSales:7.5,priority:"critical"},seasonal:{description:"Seasonal inventory and sales variations",amount:i.annualRevenue*(i.seasonality||.15),daysOfSales:365*(i.seasonality||.15),priority:"high"},growth:{description:"Supporting business growth initiatives",amount:i.annualRevenue*(i.growthRate||.08),daysOfSales:365*(i.growthRate||.08),priority:"medium"},contingency:{description:"Emergency cash reserves",amount:1.5*i.monthlyAverage,daysOfSales:45,priority:"high"},employeeCount:r,facilityCount:s}}async generateWorkingCapitalForecasts(e){const{workingCapital:t,currentAssets:a,currentLiabilities:i,salesData:n,period:r}=e,s=[];let c=t;for(let o=1;o<=r;o++){const e=1+n.growthRate/12,t=1+Math.sin(o/12*2*Math.PI)*n.seasonality,a=n.monthlyAverage*e*t,i=1.5*a,r=.65*a*1.8,l=.65*a*1.4;c=i+r-l,s.push({month:o,date:new Date(Date.now()+30*o*24*60*60*1e3).toISOString(),workingCapital:c,accountsReceivable:i,inventory:r,accountsPayable:l,revenue:a,cashFlow:.12*a,requirements:c})}return s}generateOptimizationRecommendations(e){const{currentRatio:t,quickRatio:a,cashConversionCycle:i,workingCapitalTurnover:n,benchmarks:r,requirements:s}=e,c=[];return t<r.currentRatio.target&&c.push({category:"Liquidity",priority:"high",issue:"Low current ratio indicates potential liquidity stress",recommendation:"Increase current assets or reduce short-term liabilities",potentialImpact:"Improved financial stability",targetValue:r.currentRatio.target,currentValue:t}),i>r.cashConversionCycle.target&&c.push({category:"Efficiency",priority:"high",issue:"Extended cash conversion cycle ties up working capital",recommendation:"Accelerate collections, optimize inventory levels, extend payment terms",potentialImpact:`Â£${Math.round((i-r.cashConversionCycle.target)*s.operational.amount/30)}K in freed capital`,targetValue:r.cashConversionCycle.target,currentValue:i}),n<r.workingCapitalTurnover.target&&c.push({category:"Efficiency",priority:"medium",issue:"Low working capital turnover indicates inefficient capital utilization",recommendation:"Optimize working capital levels relative to sales volume",potentialImpact:"Improved return on working capital investment",targetValue:r.workingCapitalTurnover.target,currentValue:n}),c}calculatePerformanceScore(e){const{currentRatio:t,quickRatio:a,cashConversionCycle:i,workingCapitalTurnover:n,benchmarks:r}=e;let s=0,c=0;return c+=25,t>=r.currentRatio.excellent?s+=25:t>=r.currentRatio.good?s+=20:t>=r.currentRatio.target?s+=15:s+=Math.max(0,t/r.currentRatio.target*10),c+=25,a>=r.quickRatio.excellent?s+=25:a>=r.quickRatio.good?s+=20:a>=r.quickRatio.target?s+=15:s+=Math.max(0,a/r.quickRatio.target*10),c+=25,i<=r.cashConversionCycle.excellent?s+=25:i<=r.cashConversionCycle.good?s+=20:i<=r.cashConversionCycle.target?s+=15:s+=Math.max(0,10-(i-r.cashConversionCycle.target)/10),c+=25,n>=r.workingCapitalTurnover.excellent?s+=25:n>=r.workingCapitalTurnover.good?s+=20:n>=r.workingCapitalTurnover.target?s+=15:s+=Math.max(0,n/r.workingCapitalTurnover.target*10),Math.round(s/100*100)}assessWorkingCapitalRisk(e){const{workingCapital:t,ratios:a,cashConversionCycle:i,forecasts:n}=e,r=[];a.current<1.2&&r.push({level:"high",category:"Liquidity Risk",description:"Current ratio below safe threshold",impact:"Difficulty meeting short-term obligations"}),a.quick<.8&&r.push({level:"high",category:"Quick Liquidity Risk",description:"Quick ratio indicates potential cash shortfall",impact:"May need to liquidate inventory to meet obligations"}),i>60&&r.push({level:"medium",category:"Efficiency Risk",description:"Extended cash conversion cycle",impact:"Excessive working capital tied up in operations"}),n&&n.some(e=>e.workingCapital<.8*t)&&r.push({level:"medium",category:"Forecast Risk",description:"Working capital projected to decline significantly",impact:"Future liquidity constraints possible"});return{overall:r.some(e=>"high"===e.level)?"high":r.some(e=>"medium"===e.level)?"medium":"low",risks:r,riskScore:15*r.length}}async fetchEmployeeCount(){try{const e=await fetch(`${this.apiBaseUrl}/company/employees/count`);if(e.ok){return(await e.json()).count||150}}catch(e){}return 150}async fetchFacilityCount(){try{const e=await fetch(`${this.apiBaseUrl}/company/facilities/count`);if(e.ok){return(await e.json()).count||3}}catch(e){}return 3}async fetchPrepaidExpenses(){return.02*(await this.fetchSalesData(12)).annualRevenue}async fetchOtherCurrentAssets(){return.01*(await this.fetchSalesData(12)).annualRevenue}async fetchShortTermDebt(){return.05*(await this.fetchSalesData(12)).annualRevenue}async fetchAccruedExpenses(){return.03*(await this.fetchSalesData(12)).annualRevenue}async fetchTaxesPayable(){return.15*(await this.fetchSalesData(12)).annualRevenue/4}async fetchOtherCurrentLiabilities(){return.015*(await this.fetchSalesData(12)).annualRevenue}isValidCache(e){const t=this.cacheTimestamps.get(e);return t&&Date.now()-t<this.refreshInterval}setCache(e,t){this.cache.set(e,t),this.cacheTimestamps.set(e,Date.now())}clearCache(){this.cache.clear(),this.cacheTimestamps.clear()}}export{e as E};
