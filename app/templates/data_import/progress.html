{% extends "base.html" %}

{% block title %}Import Progress - {{ data_import.import_name }}{% endblock %}

{% block head %}
<style>
.progress-container {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.progress-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 1rem;
}

.import-info {
    display: flex;
    flex-direction: column;
}

.import-name {
    font-size: 1.25rem;
    font-weight: 600;
    color: #495057;
    margin: 0;
}

.import-details {
    color: #6c757d;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.status-badge {
    padding: 0.375rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
    text-transform: uppercase;
}

.status-pending { background: #fff3cd; color: #856404; }
.status-processing { background: #cce5ff; color: #004085; }
.status-validating { background: #e2e3e5; color: #383d41; }
.status-completed { background: #d4edda; color: #155724; }
.status-failed { background: #f8d7da; color: #721c24; }
.status-cancelled { background: #f8f9fa; color: #6c757d; }

.progress-main {
    margin-bottom: 1.5rem;
}

.progress-bar-container {
    position: relative;
    margin-bottom: 1rem;
}

.progress {
    height: 12px;
    border-radius: 6px;
}

.progress-percentage {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.75rem;
    font-weight: 600;
    color: white;
    text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
}

.current-step {
    font-size: 0.875rem;
    color: #6c757d;
    text-align: center;
}

.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.metric-card {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 6px;
    text-align: center;
}

.metric-value {
    font-size: 1.5rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.25rem;
}

.metric-label {
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.logs-container {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 1.5rem;
}

.logs-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #dee2e6;
    background: #f8f9fa;
    border-radius: 8px 8px 0 0;
}

.logs-content {
    max-height: 400px;
    overflow-y: auto;
    padding: 0;
}

.log-entry {
    padding: 0.75rem 1.5rem;
    border-bottom: 1px solid #f1f3f4;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.log-entry:last-child {
    border-bottom: none;
}

.log-level {
    padding: 0.125rem 0.5rem;
    border-radius: 3px;
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    flex-shrink: 0;
    min-width: 60px;
    text-align: center;
}

.log-debug { background: #e9ecef; color: #495057; }
.log-info { background: #cce5ff; color: #004085; }
.log-warning { background: #fff3cd; color: #856404; }
.log-error { background: #f8d7da; color: #721c24; }
.log-critical { background: #dc3545; color: white; }

.log-content {
    flex: 1;
}

.log-message {
    margin: 0 0 0.25rem 0;
    color: #495057;
    font-size: 0.875rem;
}

.log-timestamp {
    font-size: 0.75rem;
    color: #6c757d;
}

.error-summary {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.error-stats {
    display: flex;
    gap: 2rem;
    margin-bottom: 1rem;
}

.error-stat {
    text-align: center;
}

.error-count {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.error-count.errors { color: #dc3545; }
.error-count.warnings { color: #fd7e14; }

.actions-container {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1.5rem;
}

.btn-group .btn + .btn {
    margin-left: 0.5rem;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.processing-indicator {
    animation: pulse 2s infinite;
}

.auto-refresh {
    font-size: 0.75rem;
    color: #6c757d;
    margin-left: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">Import Progress</h1>
                    <p class="text-muted mb-0">Monitor the progress of your data import</p>
                </div>
                <div>
                    <a href="{{ url_for('data_import.history') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Back to History
                    </a>
                    {% if data_import.status.value in ['completed', 'failed'] %}
                    <a href="{{ url_for('data_import.details', import_id=data_import.id) }}" class="btn btn-outline-primary">
                        <i class="fas fa-info-circle"></i> View Details
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Overview -->
    <div class="progress-container">
        <div class="progress-header">
            <div class="import-info">
                <h4 class="import-name">{{ data_import.import_name }}</h4>
                <div class="import-details">
                    <span><i class="fas fa-file"></i> {{ data_import.original_filename }}</span>
                    <span class="mx-2">•</span>
                    <span><i class="fas fa-tag"></i> {{ data_import.import_type.value|title }}</span>
                    <span class="mx-2">•</span>
                    <span><i class="fas fa-clock"></i> Started {{ data_import.started_at.strftime('%Y-%m-%d %H:%M:%S') if data_import.started_at else 'Not started' }}</span>
                </div>
            </div>
            <div>
                <span class="status-badge status-{{ data_import.status.value }}" id="statusBadge">
                    {{ data_import.status.value|title }}
                </span>
            </div>
        </div>

        <div class="progress-main">
            <div class="progress-bar-container">
                <div class="progress">
                    <div class="progress-bar {% if data_import.status.value == 'processing' %}processing-indicator{% endif %}" 
                         id="progressBar"
                         role="progressbar" 
                         style="width: {{ data_import.progress_percentage }}%"
                         aria-valuenow="{{ data_import.progress_percentage }}" 
                         aria-valuemin="0" 
                         aria-valuemax="100">
                    </div>
                </div>
                <div class="progress-percentage" id="progressPercentage">
                    {{ data_import.progress_percentage }}%
                </div>
            </div>
            <div class="current-step" id="currentStep">
                {{ data_import.current_step or 'Initializing...' }}
            </div>
        </div>

        <!-- Metrics -->
        <div class="metrics-grid" id="metricsGrid">
            <div class="metric-card">
                <div class="metric-value" id="totalRows">{{ data_import.total_rows or 0 }}</div>
                <div class="metric-label">Total Rows</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="processedRows">{{ data_import.processed_rows or 0 }}</div>
                <div class="metric-label">Processed</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="successfulRows">{{ data_import.successful_rows or 0 }}</div>
                <div class="metric-label">Successful</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="failedRows">{{ data_import.failed_rows or 0 }}</div>
                <div class="metric-label">Failed</div>
            </div>
        </div>
    </div>

    <!-- Error Summary -->
    <div class="error-summary" id="errorSummary">
        <h5><i class="fas fa-exclamation-triangle"></i> Validation Summary</h5>
        <div class="error-stats">
            <div class="error-stat">
                <div class="error-count errors" id="errorCount">0</div>
                <div class="metric-label">Errors</div>
            </div>
            <div class="error-stat">
                <div class="error-count warnings" id="warningCount">0</div>
                <div class="metric-label">Warnings</div>
            </div>
        </div>
    </div>

    <!-- Activity Log -->
    <div class="logs-container">
        <div class="logs-header">
            <h5 class="mb-0">
                <i class="fas fa-list"></i> Activity Log
                {% if data_import.status.value in ['processing', 'validating'] %}
                <span class="auto-refresh">Auto-refreshing every 5 seconds</span>
                {% endif %}
            </h5>
        </div>
        <div class="logs-content" id="logsContent">
            <!-- Logs will be loaded here -->
        </div>
    </div>

    <!-- Actions -->
    <div class="actions-container">
        <div class="btn-group">
            <button type="button" class="btn btn-outline-primary" id="refreshBtn">
                <i class="fas fa-sync"></i> Refresh
            </button>
            {% if data_import.status.value == 'processing' %}
            <button type="button" class="btn btn-outline-warning" id="cancelBtn">
                <i class="fas fa-stop"></i> Cancel Import
            </button>
            {% endif %}
            {% if data_import.status.value == 'failed' %}
            <button type="button" class="btn btn-outline-success" id="retryBtn">
                <i class="fas fa-redo"></i> Retry Import
            </button>
            {% endif %}
        </div>
    </div>
</div>

<script>
class ImportProgressTracker {
    constructor(importId) {
        this.importId = importId;
        this.refreshInterval = null;
        this.isRefreshing = false;
        this.initEventListeners();
        this.startAutoRefresh();
        this.refreshProgress(); // Initial load
    }
    
    initEventListeners() {
        document.getElementById('refreshBtn').addEventListener('click', () => {
            this.refreshProgress();
        });
        
        const cancelBtn = document.getElementById('cancelBtn');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                this.cancelImport();
            });
        }
        
        const retryBtn = document.getElementById('retryBtn');
        if (retryBtn) {
            retryBtn.addEventListener('click', () => {
                this.retryImport();
            });
        }
    }
    
    async refreshProgress() {
        if (this.isRefreshing) return;
        
        this.isRefreshing = true;
        const refreshBtn = document.getElementById('refreshBtn');
        const originalText = refreshBtn.innerHTML;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
        refreshBtn.disabled = true;
        
        try {
            const response = await fetch(`{{ url_for('data_import.api_progress', import_id='') }}${this.importId}`);
            const data = await response.json();
            
            if (response.ok) {
                this.updateProgress(data.import);
                this.updateLogs(data.logs);
                this.updateErrorSummary(data.error_summary);
                
                // Stop auto-refresh if import is complete
                if (['completed', 'failed', 'cancelled'].includes(data.import.status)) {
                    this.stopAutoRefresh();
                }
            } else {
                console.error('Failed to fetch progress:', data.error);
            }
        } catch (error) {
            console.error('Error fetching progress:', error);
        } finally {
            refreshBtn.innerHTML = originalText;
            refreshBtn.disabled = false;
            this.isRefreshing = false;
        }
    }
    
    updateProgress(importData) {
        // Update status badge
        const statusBadge = document.getElementById('statusBadge');
        statusBadge.className = `status-badge status-${importData.status}`;
        statusBadge.textContent = importData.status.charAt(0).toUpperCase() + importData.status.slice(1);
        
        // Update progress bar
        const progressBar = document.getElementById('progressBar');
        const progressPercentage = document.getElementById('progressPercentage');
        const currentStep = document.getElementById('currentStep');
        
        progressBar.style.width = `${importData.progress_percentage}%`;
        progressBar.setAttribute('aria-valuenow', importData.progress_percentage);
        progressPercentage.textContent = `${importData.progress_percentage}%`;
        currentStep.textContent = importData.current_step || 'Waiting...';
        
        // Update processing animation
        if (importData.status === 'processing') {
            progressBar.classList.add('processing-indicator');
        } else {
            progressBar.classList.remove('processing-indicator');
        }
        
        // Update metrics
        document.getElementById('totalRows').textContent = importData.total_rows || 0;
        document.getElementById('processedRows').textContent = importData.processed_rows || 0;
        document.getElementById('successfulRows').textContent = importData.successful_rows || 0;
        document.getElementById('failedRows').textContent = importData.failed_rows || 0;
    }
    
    updateLogs(logs) {
        const logsContent = document.getElementById('logsContent');
        
        if (logs.length === 0) {
            logsContent.innerHTML = '<div class="p-3 text-center text-muted">No activity logs yet</div>';
            return;
        }
        
        logsContent.innerHTML = logs.map(log => `
            <div class="log-entry">
                <div class="log-level log-${log.log_level.toLowerCase()}">${log.log_level}</div>
                <div class="log-content">
                    <div class="log-message">${log.log_message}</div>
                    <div class="log-timestamp">${new Date(log.created_at).toLocaleString()}</div>
                </div>
            </div>
        `).join('');
        
        // Auto-scroll to bottom
        logsContent.scrollTop = logsContent.scrollHeight;
    }
    
    updateErrorSummary(errorSummary) {
        document.getElementById('errorCount').textContent = errorSummary.errors || 0;
        document.getElementById('warningCount').textContent = errorSummary.warnings || 0;
    }
    
    startAutoRefresh() {
        const status = '{{ data_import.status.value }}';
        if (['processing', 'validating', 'pending'].includes(status)) {
            this.refreshInterval = setInterval(() => {
                this.refreshProgress();
            }, 5000); // Refresh every 5 seconds
        }
    }
    
    stopAutoRefresh() {
        if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
            this.refreshInterval = null;
        }
    }
    
    async cancelImport() {
        if (!confirm('Are you sure you want to cancel this import?')) {
            return;
        }
        
        try {
            const response = await fetch(`{{ url_for('data_import.api_progress', import_id='') }}${this.importId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            });
            
            if (response.ok) {
                this.refreshProgress();
            } else {
                alert('Failed to cancel import');
            }
        } catch (error) {
            console.error('Error canceling import:', error);
            alert('Error canceling import');
        }
    }
    
    async retryImport() {
        if (!confirm('Are you sure you want to retry this import? This will create a new import process.')) {
            return;
        }
        
        try {
            const response = await fetch(`{{ url_for('data_import.api_progress', import_id='') }}${this.importId}/retry`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            });
            
            const data = await response.json();
            
            if (response.ok && data.new_import_id) {
                window.location.href = `{{ url_for('data_import.progress', import_id='') }}${data.new_import_id}`;
            } else {
                alert('Failed to retry import');
            }
        } catch (error) {
            console.error('Error retrying import:', error);
            alert('Error retrying import');
        }
    }
}

// Initialize progress tracker
const progressTracker = new ImportProgressTracker('{{ data_import.id }}');

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    progressTracker.stopAutoRefresh();
});
</script>
{% endblock %}