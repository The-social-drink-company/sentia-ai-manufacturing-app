# nixpacks.toml
# Production-ready Railway deployment configuration
# Optimized for Sentia Manufacturing Dashboard with Caddy

providers = ["node"]

[phases.setup]
# Install Caddy for static file serving
aptPkgs = ["curl", "ca-certificates"]
nixPkgs = ["caddy"]

[phases.install]
# Clean install with optimizations
cmds = [
    "npm ci --prefer-offline --no-audit --silent",
    "npm cache clean --force"
]

[phases.build]
# Build React app and prepare for Caddy
cmds = [
    "npm run build",
    "ls -la dist/ || echo 'No dist folder found'",
    "test -f dist/index.html || echo 'ERROR: index.html not found in dist'"
]
cacheDirectories = ["node_modules", ".npm"]

[start]
# Use Caddy to serve static files - this fixes all Railway deployment issues
cmd = "caddy run --config Caddyfile --adapter caddyfile"

[variables]
NODE_ENV = "production"
NPM_CONFIG_PRODUCTION = "false"
# Ensure PORT is available for Caddy
PORT = "8080"
# Database connection optimization
DATABASE_CONNECTION_LIMIT = "5"
DATABASE_IDLE_TIMEOUT = "30000"
# Build optimization
BUILD_CACHE_VERSION = "v3-caddy-static-fix"