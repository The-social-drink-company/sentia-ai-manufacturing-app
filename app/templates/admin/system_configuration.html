{% extends "base.html" %}

{% block title %}System Configuration{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-cog"></i> System Configuration</h1>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-success" onclick="saveAllSettings()">
                        <i class="fas fa-save"></i> Save All Changes
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetToDefaults()">
                        <i class="fas fa-undo"></i> Reset to Defaults
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- General Settings -->
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">General Settings</h6>
                </div>
                <div class="card-body">
                    <form id="generalSettingsForm">
                        <div class="mb-3">
                            <label for="app_name" class="form-label">Application Name</label>
                            <input type="text" class="form-control" id="app_name" name="app_name" 
                                   value="{{ settings.get('app_name').value if settings.get('app_name') else 'Sentia Manufacturing Dashboard' }}">
                            <div class="form-text">The name displayed in the application header.</div>
                        </div>

                        <div class="mb-3">
                            <label for="app_description" class="form-label">Application Description</label>
                            <textarea class="form-control" id="app_description" name="app_description" rows="3">{{ settings.get('app_description').value if settings.get('app_description') else 'Manufacturing planning and inventory optimization system' }}</textarea>
                        </div>

                        <div class="mb-3">
                            <label for="timezone" class="form-label">Default Timezone</label>
                            <select class="form-select" id="timezone" name="timezone">
                                <option value="UTC" {{ 'selected' if settings.get('timezone') and settings.get('timezone').value == 'UTC' else '' }}>UTC</option>
                                <option value="America/New_York" {{ 'selected' if settings.get('timezone') and settings.get('timezone').value == 'America/New_York' else '' }}>Eastern Time</option>
                                <option value="America/Chicago" {{ 'selected' if settings.get('timezone') and settings.get('timezone').value == 'America/Chicago' else '' }}>Central Time</option>
                                <option value="America/Denver" {{ 'selected' if settings.get('timezone') and settings.get('timezone').value == 'America/Denver' else '' }}>Mountain Time</option>
                                <option value="America/Los_Angeles" {{ 'selected' if settings.get('timezone') and settings.get('timezone').value == 'America/Los_Angeles' else '' }}>Pacific Time</option>
                                <option value="Europe/London" {{ 'selected' if settings.get('timezone') and settings.get('timezone').value == 'Europe/London' else '' }}>London</option>
                                <option value="Europe/Paris" {{ 'selected' if settings.get('timezone') and settings.get('timezone').value == 'Europe/Paris' else '' }}>Paris</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="date_format" class="form-label">Date Format</label>
                            <select class="form-select" id="date_format" name="date_format">
                                <option value="YYYY-MM-DD" {{ 'selected' if settings.get('date_format') and settings.get('date_format').value == 'YYYY-MM-DD' else '' }}>YYYY-MM-DD</option>
                                <option value="MM/DD/YYYY" {{ 'selected' if settings.get('date_format') and settings.get('date_format').value == 'MM/DD/YYYY' else '' }}>MM/DD/YYYY</option>
                                <option value="DD/MM/YYYY" {{ 'selected' if settings.get('date_format') and settings.get('date_format').value == 'DD/MM/YYYY' else '' }}>DD/MM/YYYY</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="currency" class="form-label">Default Currency</label>
                            <select class="form-select" id="currency" name="currency">
                                <option value="USD" {{ 'selected' if settings.get('currency') and settings.get('currency').value == 'USD' else '' }}>USD - US Dollar</option>
                                <option value="EUR" {{ 'selected' if settings.get('currency') and settings.get('currency').value == 'EUR' else '' }}>EUR - Euro</option>
                                <option value="GBP" {{ 'selected' if settings.get('currency') and settings.get('currency').value == 'GBP' else '' }}>GBP - British Pound</option>
                                <option value="CAD" {{ 'selected' if settings.get('currency') and settings.get('currency').value == 'CAD' else '' }}>CAD - Canadian Dollar</option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Security Settings -->
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-warning">Security Settings</h6>
                </div>
                <div class="card-body">
                    <form id="securitySettingsForm">
                        <div class="mb-3">
                            <label for="session_timeout" class="form-label">Session Timeout (minutes)</label>
                            <input type="number" class="form-control" id="session_timeout" name="session_timeout" 
                                   value="{{ settings.get('session_timeout').value if settings.get('session_timeout') else '60' }}" 
                                   min="15" max="480">
                            <div class="form-text">Users will be logged out after this period of inactivity.</div>
                        </div>

                        <div class="mb-3">
                            <label for="max_login_attempts" class="form-label">Maximum Login Attempts</label>
                            <input type="number" class="form-control" id="max_login_attempts" name="max_login_attempts" 
                                   value="{{ settings.get('max_login_attempts').value if settings.get('max_login_attempts') else '5' }}" 
                                   min="3" max="10">
                            <div class="form-text">Account will be locked after this many failed attempts.</div>
                        </div>

                        <div class="mb-3">
                            <label for="lockout_duration" class="form-label">Lockout Duration (minutes)</label>
                            <input type="number" class="form-control" id="lockout_duration" name="lockout_duration" 
                                   value="{{ settings.get('lockout_duration').value if settings.get('lockout_duration') else '15' }}" 
                                   min="5" max="120">
                            <div class="form-text">How long accounts remain locked after failed attempts.</div>
                        </div>

                        <div class="mb-3">
                            <label for="password_min_length" class="form-label">Minimum Password Length</label>
                            <input type="number" class="form-control" id="password_min_length" name="password_min_length" 
                                   value="{{ settings.get('password_min_length').value if settings.get('password_min_length') else '8' }}" 
                                   min="6" max="32">
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="require_special_chars" name="require_special_chars" 
                                       {{ 'checked' if settings.get('require_special_chars') and settings.get('require_special_chars').value == 'true' else '' }}>
                                <label class="form-check-label" for="require_special_chars">
                                    Require Special Characters in Passwords
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enable_2fa" name="enable_2fa" 
                                       {{ 'checked' if settings.get('enable_2fa') and settings.get('enable_2fa').value == 'true' else '' }}>
                                <label class="form-check-label" for="enable_2fa">
                                    Enable Two-Factor Authentication
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Email Settings -->
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">Email Settings</h6>
                </div>
                <div class="card-body">
                    <form id="emailSettingsForm">
                        <div class="mb-3">
                            <label for="smtp_server" class="form-label">SMTP Server</label>
                            <input type="text" class="form-control" id="smtp_server" name="smtp_server" 
                                   value="{{ settings.get('smtp_server').value if settings.get('smtp_server') else 'localhost' }}">
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="smtp_port" class="form-label">SMTP Port</label>
                                <input type="number" class="form-control" id="smtp_port" name="smtp_port" 
                                       value="{{ settings.get('smtp_port').value if settings.get('smtp_port') else '587' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="smtp_encryption" class="form-label">Encryption</label>
                                <select class="form-select" id="smtp_encryption" name="smtp_encryption">
                                    <option value="tls" {{ 'selected' if settings.get('smtp_encryption') and settings.get('smtp_encryption').value == 'tls' else '' }}>TLS</option>
                                    <option value="ssl" {{ 'selected' if settings.get('smtp_encryption') and settings.get('smtp_encryption').value == 'ssl' else '' }}>SSL</option>
                                    <option value="none" {{ 'selected' if settings.get('smtp_encryption') and settings.get('smtp_encryption').value == 'none' else '' }}>None</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="smtp_username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="smtp_username" name="smtp_username" 
                                       value="{{ settings.get('smtp_username').value if settings.get('smtp_username') else '' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="smtp_password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="smtp_password" name="smtp_password" 
                                       placeholder="Enter new password or leave blank to keep current">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="from_email" class="form-label">From Email Address</label>
                            <input type="email" class="form-control" id="from_email" name="from_email" 
                                   value="{{ settings.get('from_email').value if settings.get('from_email') else 'noreply@company.com' }}">
                        </div>

                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-primary" onclick="testEmail()">
                                <i class="fas fa-envelope"></i> Test Email Configuration
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Performance Settings -->
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-success">Performance Settings</h6>
                </div>
                <div class="card-body">
                    <form id="performanceSettingsForm">
                        <div class="mb-3">
                            <label for="cache_timeout" class="form-label">Cache Timeout (seconds)</label>
                            <input type="number" class="form-control" id="cache_timeout" name="cache_timeout" 
                                   value="{{ settings.get('cache_timeout').value if settings.get('cache_timeout') else '300' }}" 
                                   min="60" max="3600">
                            <div class="form-text">How long to cache frequently accessed data.</div>
                        </div>

                        <div class="mb-3">
                            <label for="max_workers" class="form-label">Maximum Background Workers</label>
                            <input type="number" class="form-control" id="max_workers" name="max_workers" 
                                   value="{{ settings.get('max_workers').value if settings.get('max_workers') else '4' }}" 
                                   min="1" max="16">
                            <div class="form-text">Number of background processes for heavy computations.</div>
                        </div>

                        <div class="mb-3">
                            <label for="query_timeout" class="form-label">Database Query Timeout (seconds)</label>
                            <input type="number" class="form-control" id="query_timeout" name="query_timeout" 
                                   value="{{ settings.get('query_timeout').value if settings.get('query_timeout') else '30' }}" 
                                   min="5" max="300">
                        </div>

                        <div class="mb-3">
                            <label for="file_upload_max_size" class="form-label">Max File Upload Size (MB)</label>
                            <input type="number" class="form-control" id="file_upload_max_size" name="file_upload_max_size" 
                                   value="{{ settings.get('file_upload_max_size').value if settings.get('file_upload_max_size') else '50' }}" 
                                   min="1" max="500">
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enable_compression" name="enable_compression" 
                                       {{ 'checked' if settings.get('enable_compression') and settings.get('enable_compression').value == 'true' else '' }}>
                                <label class="form-check-label" for="enable_compression">
                                    Enable Response Compression
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enable_debug_mode" name="enable_debug_mode" 
                                       {{ 'checked' if settings.get('enable_debug_mode') and settings.get('enable_debug_mode').value == 'true' else '' }}>
                                <label class="form-check-label" for="enable_debug_mode">
                                    Enable Debug Mode
                                </label>
                                <div class="form-text text-warning">WARNING: Only enable in development environments.</div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Feature Flags -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-secondary">Feature Flags</h6>
                </div>
                <div class="card-body">
                    <form id="featureFlagsForm">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_forecasting" name="enable_forecasting" 
                                           {{ 'checked' if settings.get('enable_forecasting') and settings.get('enable_forecasting').value == 'true' else '' }}>
                                    <label class="form-check-label" for="enable_forecasting">
                                        Advanced Forecasting
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_optimization" name="enable_optimization" 
                                           {{ 'checked' if settings.get('enable_optimization') and settings.get('enable_optimization').value == 'true' else '' }}>
                                    <label class="form-check-label" for="enable_optimization">
                                        Stock Optimization
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_api_integrations" name="enable_api_integrations" 
                                           {{ 'checked' if settings.get('enable_api_integrations') and settings.get('enable_api_integrations').value == 'true' else '' }}>
                                    <label class="form-check-label" for="enable_api_integrations">
                                        API Integrations
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_analytics" name="enable_analytics" 
                                           {{ 'checked' if settings.get('enable_analytics') and settings.get('enable_analytics').value == 'true' else '' }}>
                                    <label class="form-check-label" for="enable_analytics">
                                        Advanced Analytics
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_exports" name="enable_exports" 
                                           {{ 'checked' if settings.get('enable_exports') and settings.get('enable_exports').value == 'true' else '' }}>
                                    <label class="form-check-label" for="enable_exports">
                                        Data Export
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_notifications" name="enable_notifications" 
                                           {{ 'checked' if settings.get('enable_notifications') and settings.get('enable_notifications').value == 'true' else '' }}>
                                    <label class="form-check-label" for="enable_notifications">
                                        Email Notifications
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_audit_logs" name="enable_audit_logs" 
                                           {{ 'checked' if settings.get('enable_audit_logs') and settings.get('enable_audit_logs').value == 'true' else '' }}>
                                    <label class="form-check-label" for="enable_audit_logs">
                                        Audit Logging
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable_api_rate_limiting" name="enable_api_rate_limiting" 
                                           {{ 'checked' if settings.get('enable_api_rate_limiting') and settings.get('enable_api_rate_limiting').value == 'true' else '' }}>
                                    <label class="form-check-label" for="enable_api_rate_limiting">
                                        API Rate Limiting
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="maintenance_mode" name="maintenance_mode" 
                                           {{ 'checked' if settings.get('maintenance_mode') and settings.get('maintenance_mode').value == 'true' else '' }}>
                                    <label class="form-check-label" for="maintenance_mode">
                                        Maintenance Mode
                                    </label>
                                    <div class="form-text text-warning">This will block user access to the application.</div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configuration Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="statusMessage"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function saveAllSettings() {
    const forms = ['generalSettingsForm', 'securitySettingsForm', 'emailSettingsForm', 'performanceSettingsForm', 'featureFlagsForm'];
    const allSettings = {};
    
    forms.forEach(formId => {
        const form = document.getElementById(formId);
        const formData = new FormData(form);
        
        for (let [key, value] of formData.entries()) {
            allSettings[key] = value;
        }
        
        // Handle checkboxes (they won't appear in FormData if unchecked)
        const checkboxes = form.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            allSettings[checkbox.name] = checkbox.checked ? 'true' : 'false';
        });
    });
    
    fetch('/admin/system-config/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(allSettings)
    })
    .then(response => response.json())
    .then(data => {
        showStatusModal(data.success ? 'success' : 'error', data.message);
        if (data.success) {
            // Optionally reload page after successful save
            setTimeout(() => location.reload(), 2000);
        }
    })
    .catch(error => {
        showStatusModal('error', 'Failed to save configuration: ' + error.message);
    });
}

function resetToDefaults() {
    if (confirm('Are you sure you want to reset all settings to their default values? This cannot be undone.')) {
        // Reset form values to defaults
        document.getElementById('generalSettingsForm').reset();
        document.getElementById('securitySettingsForm').reset();
        document.getElementById('emailSettingsForm').reset();
        document.getElementById('performanceSettingsForm').reset();
        document.getElementById('featureFlagsForm').reset();
        
        // Set default values
        document.getElementById('app_name').value = 'Sentia Manufacturing Dashboard';
        document.getElementById('session_timeout').value = '60';
        document.getElementById('max_login_attempts').value = '5';
        document.getElementById('cache_timeout').value = '300';
        
        showStatusModal('info', 'Settings reset to defaults. Remember to save your changes.');
    }
}

function testEmail() {
    const form = document.getElementById('emailSettingsForm');
    const formData = new FormData(form);
    const emailSettings = {};
    
    for (let [key, value] of formData.entries()) {
        emailSettings[key] = value;
    }
    
    fetch('/admin/test-email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(emailSettings)
    })
    .then(response => response.json())
    .then(data => {
        showStatusModal(data.success ? 'success' : 'error', data.message);
    })
    .catch(error => {
        showStatusModal('error', 'Failed to test email: ' + error.message);
    });
}

function showStatusModal(type, message) {
    const modalElement = document.getElementById('statusModal');
    const messageElement = document.getElementById('statusMessage');
    
    let alertClass = 'alert-info';
    if (type === 'success') alertClass = 'alert-success';
    else if (type === 'error') alertClass = 'alert-danger';
    else if (type === 'warning') alertClass = 'alert-warning';
    
    messageElement.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
    
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
}

// Warn user about unsaved changes
let hasUnsavedChanges = false;

document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.addEventListener('change', () => {
            hasUnsavedChanges = true;
        });
    });
});

window.addEventListener('beforeunload', function(e) {
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// Reset unsaved changes flag when settings are saved
function markSaved() {
    hasUnsavedChanges = false;
}
</script>
{% endblock %}