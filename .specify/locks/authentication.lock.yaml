# Authentication Component Lock File
# TASK-004: Specification Lock to Prevent AI Drift
# This file defines immutable requirements for authentication

component: Authentication
version: 1.0.0
locked: true
created: 2025-09-22T16:45:00Z
last_updated: 2025-09-22T16:45:00Z

# CRITICAL INVARIANTS - NEVER CHANGE THESE
invariants:
  - provider: "Clerk is the ONLY authentication provider"
  - middleware_order: "Health endpoints MUST be defined BEFORE authentication middleware"
  - environment_validation: "All Clerk environment variables MUST be validated on startup"
  - cors_configuration: "CORS MUST allow all deployment environments and Clerk domains"
  - error_handling: "Authentication failures MUST show user-friendly messages, not blank screens"

# REQUIRED ENVIRONMENT VARIABLES
required_env_vars:
  backend:
    - CLERK_SECRET_KEY
    - DATABASE_URL_DEVELOPMENT
    - DATABASE_URL_TESTING
    - DATABASE_URL_PRODUCTION
  frontend:
    - VITE_CLERK_PUBLISHABLE_KEY
    - VITE_CLERK_DOMAIN

# MIDDLEWARE ORDER SPECIFICATION
middleware_order:
  1: "Health check endpoints (/health, /health/live, /health/ready)"
  2: "Security middleware (helmet, CORS)"
  3: "Body parsing middleware"
  4: "Authentication middleware (Clerk)"
  5: "Protected routes"

# CORS ALLOWED ORIGINS
cors_origins:
  production:
    - "https://deployrend.financeflo.ai"
    - "https://sentiaprod.financeflo.ai"
    - "https://sentia.onrender.com"
  testing:
    - "https://sentia-testing.onrender.com"
    - "https://sentia-manufacturing-testing.onrender.com"
  development:
    - "https://sentia-manufacturing-development.onrender.com"
    - "http://localhost:3000"
    - "http://localhost:5173"
  clerk:
    - "https://clerk.financeflo.ai"
    - "https://robust-snake-50.clerk.accounts.dev"

# FORBIDDEN PATTERNS
forbidden:
  - "console.log in production code"
  - "hardcoded credentials"
  - "authentication bypass"
  - "middleware reordering without specification update"
  - "removing environment validation"

# VALIDATION RULES
validation:
  startup:
    - "Environment variables MUST be validated before any other initialization"
    - "Application MUST exit with clear error if required variables missing"
    - "Validation MUST log configuration status"
  runtime:
    - "Health endpoints MUST respond without authentication"
    - "Protected endpoints MUST require valid authentication"
    - "CORS errors MUST be logged with origin information"

# AI INSTRUCTIONS
ai_instructions: |
  CRITICAL: This component is LOCKED and follows strict specifications.
  
  BEFORE making ANY changes to authentication:
  1. Read this lock file completely
  2. Verify changes don't violate invariants
  3. Update version and last_updated if changes are necessary
  4. Test all validation rules
  
  NEVER:
  - Change the authentication provider from Clerk
  - Reorder middleware without updating this specification
  - Remove environment validation
  - Modify CORS without adding to allowed origins
  - Add console.log statements to production code
  
  ALWAYS:
  - Maintain middleware order as specified
  - Validate environment variables on startup
  - Use structured logging instead of console.log
  - Test authentication flows after changes
  - Update documentation when making changes

# TESTING REQUIREMENTS
testing:
  unit_tests:
    - "Environment validation functions"
    - "CORS configuration"
    - "Middleware order verification"
  integration_tests:
    - "Authentication flow end-to-end"
    - "Health check accessibility"
    - "Error handling scenarios"
  manual_tests:
    - "Login from all deployment environments"
    - "Health check without authentication"
    - "Error messages for missing environment variables"

# ROLLBACK PROCEDURES
rollback:
  triggers:
    - "Authentication failures > 5%"
    - "Health checks failing"
    - "CORS errors in production"
  steps:
    1. "Revert to last known good configuration"
    2. "Validate environment variables"
    3. "Test health endpoints"
    4. "Verify authentication flow"
    5. "Monitor error rates"

# CHANGE APPROVAL
change_approval:
  required_for:
    - "Middleware order changes"
    - "Environment variable changes"
    - "CORS configuration changes"
    - "Authentication provider changes"
  approvers:
    - "Technical Lead"
    - "Security Team"
  process:
    1. "Create specification update proposal"
    2. "Security review"
    3. "Testing in development environment"
    4. "Staged rollout"
