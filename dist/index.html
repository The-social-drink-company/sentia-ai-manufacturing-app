<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sentia Manufacturing Dashboard</title>
    <!-- Bulletproof Initialization - Handles all edge cases -->
    <script>
      // Immediate error catching to prevent blank pages
      window.addEventListener('error', function(e) {
        console.error('[Global Error]', e.message, e.filename, e.lineno);
        // Don't prevent default - we want to see errors in console
      });

      // Initialize fallback environment if needed
      if (typeof window.import === 'undefined') {
        window.import = { meta: { env: {} } };
      }

      // Set critical environment defaults immediately
      window.VITE_CLERK_PUBLISHABLE_KEY = 'pk_live_Y2xlcmsuZmluYW5jZWZsby5haSQ';
      window.VITE_MCP_SERVER_URL = 'https://mcp-server-tkyu.onrender.com';
      window.VITE_API_BASE_URL = '/api';
      window.NODE_ENV = 'production';
      
      window.import.meta.env.VITE_CLERK_PUBLISHABLE_KEY = 'pk_live_Y2xlcmsuZmluYW5jZWZsby5haSQ';
      window.import.meta.env.VITE_MCP_SERVER_URL = 'https://mcp-server-tkyu.onrender.com';
      window.import.meta.env.VITE_API_BASE_URL = '/api';
      window.import.meta.env.MODE = 'production';
    </script>

    <!-- Clerk Environment Initialization with fallback -->
    <script>
      (function() {
        // Try to load clerk-init.js but don't fail if it doesn't exist
        var script = document.createElement('script');
        script.src = '/clerk-init.js';
        script.onerror = function() {
          console.warn('[Clerk Init] Failed to load clerk-init.js, using defaults');
        };
        document.head.appendChild(script);
      })();
    </script>
    <script type="module" crossorigin src="/js/index-DuY1VrEM.js"></script>
    <link rel="modulepreload" crossorigin href="/js/auth-BIfipbc6.js">
    <link rel="modulepreload" crossorigin href="/js/vendor-utils-W0IPh-on.js">
    <link rel="modulepreload" crossorigin href="/js/charts-C-BUlHpY.js">
    <link rel="modulepreload" crossorigin href="/js/vendor-TZ9aDXZU.js">
    <link rel="modulepreload" crossorigin href="/js/react-core-DlJGLw67.js">
    <link rel="modulepreload" crossorigin href="/js/router-BgNYfmsc.js">
    <link rel="modulepreload" crossorigin href="/js/animation-Cxa7csYq.js">
    <link rel="stylesheet" crossorigin href="/css/react-core-C9-ySRfk.css">
    <link rel="stylesheet" crossorigin href="/css/index-BYUwXWTz.css">
  </head>
  <body>
    <div id="root">
      <!-- Fallback loading state if React fails to mount -->
      <div id="fallback-loader" style="
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        background: #f3f4f6;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <div style="text-align: center;">
          <div style="
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
          "></div>
          <div style="color: #6b7280; font-size: 18px;">Loading Sentia Manufacturing...</div>
          <noscript>
            <div style="color: #ef4444; margin-top: 16px;">
              JavaScript is required to run this application.
            </div>
          </noscript>
        </div>
      </div>
      <style>
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      </style>
    </div>

    <!-- Diagnostic script for debugging -->
    <script>
      // Remove fallback loader when app loads
      window.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
          var loader = document.getElementById('fallback-loader');
          if (loader && document.querySelector('#root > *:not(#fallback-loader)')) {
            loader.style.display = 'none';
          }
        }, 100);
      });

      // Add diagnostic information
      console.log('[App Init] Starting Sentia Manufacturing Dashboard');
      console.log('[App Init] Environment:', window.location.hostname);
      console.log('[App Init] Protocol:', window.location.protocol);
      console.log('[App Init] Clerk Key:', window.import?.meta?.env?.VITE_CLERK_PUBLISHABLE_KEY ? 'Present' : 'Missing');
    </script>

    <script>
      // Enterprise Service Worker Registration
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          // Only unregister in development to avoid stale caches
          if (window.location.hostname === 'localhost') {
            navigator.serviceWorker.getRegistrations().then(registrations => {
              registrations.forEach(reg => {
                reg.unregister().catch(() => {});
              });
            }).catch(() => {});
            return;
          }

          // Register service worker in production
          navigator.serviceWorker.register('/sw.js', {
            scope: '/',
            updateViaCache: 'none'
          })
          .then(registration => {
            console.log('[SW] Service worker registered successfully:', registration.scope);
            
            // Check for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              
              if (newWorker) {
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // New service worker installed, show update available message
                    if (window.dispatchEvent) {
                      window.dispatchEvent(new CustomEvent('sw-update-available'));
                    }
                  }
                });
              }
            });
          })
          .catch(error => {
            console.warn('[SW] Service worker registration failed:', error);
          });

          // Listen for service worker messages
          navigator.serviceWorker.addEventListener('message', event => {
            if (event.data && event.data.type === 'SKIP_WAITING') {
              window.location.reload();
            }
          });
        });

        // Handle service worker updates
        window.addEventListener('sw-update-available', () => {
          const updateBanner = document.createElement('div');
          updateBanner.innerHTML = `
            <div id="sw-update-banner" style="
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              background: #2563eb;
              color: white;
              padding: 12px 16px;
              text-align: center;
              z-index: 9999;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            ">
              <span style="margin-right: 16px;">A new version of Sentia Manufacturing Dashboard is available!</span>
              <button id="sw-update-now" style="
                background: white;
                color: #2563eb;
                border: none;
                padding: 6px 12px;
                border-radius: 4px;
                font-weight: 500;
                cursor: pointer;
                margin-right: 8px;
              ">Update Now</button>
              <button id="sw-update-later" style="
                background: transparent;
                color: white;
                border: 1px solid white;
                padding: 6px 12px;
                border-radius: 4px;
                font-weight: 500;
                cursor: pointer;
              ">Later</button>
            </div>
          `;
          document.body.appendChild(updateBanner);

          // Add event listeners instead of inline onclick
          const updateNowBtn = document.getElementById('sw-update-now');
          const updateLaterBtn = document.getElementById('sw-update-later');
          
          if (updateNowBtn) {
            updateNowBtn.addEventListener('click', () => {
              window.location.reload();
            });
          }

          if (updateLaterBtn) {
            updateLaterBtn.addEventListener('click', () => {
              const banner = document.getElementById('sw-update-banner');
              if (banner && banner.parentElement) {
                banner.parentElement.remove();
              }
            });
          }
        });
      }
    </script>
  </body>
</html>