{% extends "base.html" %}

{% block title %}Stock Level Optimization{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-3">Stock Level Optimization Engine</h1>
            <p class="text-muted">Intelligent stock level optimization with lead time and capacity constraints</p>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-sliders-h me-2"></i>Optimization Parameters
                    </h5>
                </div>
                <div class="card-body">
                    <form id="optimizationForm">
                        <div class="row">
                            <!-- Product Selection -->
                            <div class="col-md-3">
                                <label for="productSelect" class="form-label">Product</label>
                                <select class="form-select" id="productSelect" required>
                                    <option value="">Select Product</option>
                                    <option value="gaba-red-uk">GABA Red UK</option>
                                    <option value="gaba-red-eu">GABA Red EU</option>
                                    <option value="gaba-red-usa">GABA Red USA</option>
                                    <option value="gaba-black-uk">GABA Black UK</option>
                                    <option value="gaba-black-eu">GABA Black EU</option>
                                    <option value="gaba-black-usa">GABA Black USA</option>
                                    <option value="gaba-gold-uk">GABA Gold UK</option>
                                    <option value="gaba-gold-eu">GABA Gold EU</option>
                                    <option value="gaba-gold-usa">GABA Gold USA</option>
                                </select>
                            </div>

                            <!-- Location Selection -->
                            <div class="col-md-3">
                                <label for="locationSelect" class="form-label">Location (Optional)</label>
                                <select class="form-select" id="locationSelect">
                                    <option value="">All Locations</option>
                                    <option value="warehouse-uk">UK Warehouse</option>
                                    <option value="warehouse-eu">EU Warehouse</option>
                                    <option value="warehouse-usa">USA Warehouse</option>
                                    <option value="fba-uk">Amazon FBA UK</option>
                                    <option value="fba-usa">Amazon FBA USA</option>
                                </select>
                            </div>

                            <!-- Service Level -->
                            <div class="col-md-3">
                                <label for="serviceLevelSelect" class="form-label">Service Level Target</label>
                                <select class="form-select" id="serviceLevelSelect">
                                    <option value="0.95">95% - Basic</option>
                                    <option value="0.98" selected>98% - Standard</option>
                                    <option value="0.995">99.5% - Premium</option>
                                </select>
                            </div>

                            <!-- Optimization Objective -->
                            <div class="col-md-3">
                                <label for="objectiveSelect" class="form-label">Optimization Objective</label>
                                <select class="form-select" id="objectiveSelect">
                                    <option value="minimize_cost">Minimize Cost</option>
                                    <option value="balanced" selected>Balanced</option>
                                    <option value="maximize_service">Maximize Service</option>
                                </select>
                            </div>
                        </div>

                        <!-- Advanced Constraints (Collapsible) -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#advancedConstraints" aria-expanded="false">
                                    <i class="fas fa-cog me-1"></i>Advanced Constraints
                                </button>
                            </div>
                        </div>

                        <div class="collapse" id="advancedConstraints">
                            <div class="row mt-3">
                                <!-- Lead Time Parameters -->
                                <div class="col-md-6">
                                    <div class="card border-light">
                                        <div class="card-header bg-light">
                                            <h6 class="card-title mb-0">Lead Time Parameters</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-6">
                                                    <label for="leadTimeDays" class="form-label">Lead Time (Days)</label>
                                                    <input type="number" class="form-control" id="leadTimeDays" value="14" min="1" max="365">
                                                </div>
                                                <div class="col-6">
                                                    <label for="leadTimeVariability" class="form-label">Variability (Â±Days)</label>
                                                    <input type="number" class="form-control" id="leadTimeVariability" value="3" min="0" step="0.5">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Capacity Constraints -->
                                <div class="col-md-6">
                                    <div class="card border-light">
                                        <div class="card-header bg-light">
                                            <h6 class="card-title mb-0">Capacity Constraints</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-6">
                                                    <label for="supplierCapacity" class="form-label">Supplier Capacity (Units/Month)</label>
                                                    <input type="number" class="form-control" id="supplierCapacity" value="10000" min="0">
                                                </div>
                                                <div class="col-6">
                                                    <label for="storageCapacity" class="form-label">Storage Capacity (Units)</label>
                                                    <input type="number" class="form-control" id="storageCapacity" value="5000" min="0">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-3">
                                <!-- Cost Parameters -->
                                <div class="col-md-6">
                                    <div class="card border-light">
                                        <div class="card-header bg-light">
                                            <h6 class="card-title mb-0">Cost Parameters</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-6">
                                                    <label for="holdingCostRate" class="form-label">Holding Cost Rate (%/year)</label>
                                                    <input type="number" class="form-control" id="holdingCostRate" value="25" min="0" max="100" step="0.1">
                                                </div>
                                                <div class="col-6">
                                                    <label for="orderingCost" class="form-label">Ordering Cost ($)</label>
                                                    <input type="number" class="form-control" id="orderingCost" value="100" min="0" step="1">
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-6">
                                                    <label for="stockoutCost" class="form-label">Stockout Cost ($/unit)</label>
                                                    <input type="number" class="form-control" id="stockoutCost" value="50" min="0" step="1">
                                                </div>
                                                <div class="col-6">
                                                    <label for="storageCost" class="form-label">Storage Cost ($/unit/month)</label>
                                                    <input type="number" class="form-control" id="storageCost" value="0.10" min="0" step="0.01">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Financial Constraints -->
                                <div class="col-md-6">
                                    <div class="card border-light">
                                        <div class="card-header bg-light">
                                            <h6 class="card-title mb-0">Financial Constraints</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-12">
                                                    <label for="workingCapitalLimit" class="form-label">Working Capital Limit ($)</label>
                                                    <input type="number" class="form-control" id="workingCapitalLimit" value="100000" min="0" step="1000">
                                                </div>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-12">
                                                    <label for="capitalRate" class="form-label">Cost of Capital (%/year)</label>
                                                    <input type="number" class="form-control" id="capitalRate" value="8" min="0" max="50" step="0.1">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary me-2" id="optimizeBtn">
                                    <i class="fas fa-cog me-1"></i>Optimize Stock Levels
                                </button>
                                <button type="button" class="btn btn-secondary me-2" id="abcAnalysisBtn">
                                    <i class="fas fa-sort-alpha-down me-1"></i>ABC Analysis
                                </button>
                                <button type="button" class="btn btn-warning" id="slowMovingBtn">
                                    <i class="fas fa-turtle me-1"></i>Slow Moving Items
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>Optimization Results
                    </h5>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary active" data-view="overview">Overview</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-view="details">Details</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-view="charts">Charts</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-view="recommendations">Recommendations</button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Loading Spinner -->
                    <div id="loadingSpinner" class="text-center py-5 d-none">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Optimizing stock levels...</p>
                    </div>

                    <!-- Initial State -->
                    <div id="initialState" class="text-center py-5">
                        <i class="fas fa-boxes fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">Select a product and click "Optimize Stock Levels" to begin</h4>
                        <p class="text-muted">The optimization engine will calculate optimal stock levels, reorder points, and safety stock based on your parameters.</p>
                    </div>

                    <!-- Overview Results -->
                    <div id="overviewResults" class="d-none">
                        <div class="row" id="kpiCards">
                            <!-- KPI cards will be populated here -->
                        </div>
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="optimizationTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Location</th>
                                                <th>Current Stock</th>
                                                <th>Optimal Stock</th>
                                                <th>Reorder Point</th>
                                                <th>Order Quantity</th>
                                                <th>Safety Stock</th>
                                                <th>Service Level</th>
                                                <th>Annual Cost</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Results will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Results -->
                    <div id="detailResults" class="d-none">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card border-0 bg-light">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="card-title mb-0">Cost Breakdown</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="costBreakdown">
                                            <!-- Cost breakdown will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-0 bg-light">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="card-title mb-0">Risk Metrics</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="riskMetrics">
                                            <!-- Risk metrics will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div id="chartResults" class="d-none">
                        <div class="row">
                            <div class="col-md-6">
                                <canvas id="stockLevelChart" width="400" height="200"></canvas>
                            </div>
                            <div class="col-md-6">
                                <canvas id="costAnalysisChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-12">
                                <canvas id="timeSeriesChart" width="800" height="300"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Recommendations -->
                    <div id="recommendationResults" class="d-none">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Immediate Actions
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <ul id="immediateActions" class="list-unstyled">
                                            <!-- Immediate actions will be populated here -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-lightbulb me-1"></i>Optimization Suggestions
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <ul id="optimizationSuggestions" class="list-unstyled">
                                            <!-- Optimization suggestions will be populated here -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-check-circle me-1"></i>Risk Mitigation
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <ul id="riskMitigation" class="list-unstyled">
                                            <!-- Risk mitigation will be populated here -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ABC Analysis Results -->
                    <div id="abcResults" class="d-none">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="card-title mb-0">Category A Products</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="categoryA">
                                            <!-- Category A products will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="card-title mb-0">Category B Products</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="categoryB">
                                            <!-- Category B products will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-secondary">
                                    <div class="card-header bg-secondary text-white">
                                        <h6 class="card-title mb-0">Category C Products</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="categoryC">
                                            <!-- Category C products will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Slow Moving Results -->
                    <div id="slowMovingResults" class="d-none">
                        <div class="table-responsive">
                            <table class="table table-hover" id="slowMovingTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Product</th>
                                        <th>Location</th>
                                        <th>Current Stock</th>
                                        <th>Age (Days)</th>
                                        <th>Turnover Rate</th>
                                        <th>Value at Risk</th>
                                        <th>Risk Score</th>
                                        <th>Recommendations</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Slow moving items will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Calculators Modal -->
<div class="modal fade" id="calculatorsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Stock Optimization Calculators</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- EOQ Calculator -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">EOQ Calculator</h6>
                            </div>
                            <div class="card-body">
                                <form id="eoqCalculatorForm">
                                    <div class="mb-2">
                                        <label for="eoqAnnualDemand" class="form-label form-label-sm">Annual Demand</label>
                                        <input type="number" class="form-control form-control-sm" id="eoqAnnualDemand" required>
                                    </div>
                                    <div class="mb-2">
                                        <label for="eoqOrderingCost" class="form-label form-label-sm">Ordering Cost ($)</label>
                                        <input type="number" class="form-control form-control-sm" id="eoqOrderingCost" required>
                                    </div>
                                    <div class="mb-2">
                                        <label for="eoqHoldingRate" class="form-label form-label-sm">Holding Rate (%)</label>
                                        <input type="number" class="form-control form-control-sm" id="eoqHoldingRate" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="eoqUnitCost" class="form-label form-label-sm">Unit Cost ($)</label>
                                        <input type="number" class="form-control form-control-sm" id="eoqUnitCost" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary btn-sm">Calculate EOQ</button>
                                </form>
                                <div id="eoqResult" class="mt-3"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Safety Stock Calculator -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Safety Stock Calculator</h6>
                            </div>
                            <div class="card-body">
                                <form id="safetyStockCalculatorForm">
                                    <div class="mb-2">
                                        <label for="ssDemandMean" class="form-label form-label-sm">Monthly Demand (Mean)</label>
                                        <input type="number" class="form-control form-control-sm" id="ssDemandMean" required>
                                    </div>
                                    <div class="mb-2">
                                        <label for="ssDemandStd" class="form-label form-label-sm">Demand Std Deviation</label>
                                        <input type="number" class="form-control form-control-sm" id="ssDemandStd" required>
                                    </div>
                                    <div class="mb-2">
                                        <label for="ssLeadTime" class="form-label form-label-sm">Lead Time (Days)</label>
                                        <input type="number" class="form-control form-control-sm" id="ssLeadTime" required>
                                    </div>
                                    <div class="mb-2">
                                        <label for="ssLeadTimeVar" class="form-label form-label-sm">Lead Time Variability</label>
                                        <input type="number" class="form-control form-control-sm" id="ssLeadTimeVar" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="ssServiceLevel" class="form-label form-label-sm">Service Level</label>
                                        <select class="form-select form-select-sm" id="ssServiceLevel">
                                            <option value="0.95">95%</option>
                                            <option value="0.98" selected>98%</option>
                                            <option value="0.995">99.5%</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary btn-sm">Calculate Safety Stock</button>
                                </form>
                                <div id="safetyStockResult" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global variables
let optimizationData = null;
let charts = {};

// DOM Ready
$(document).ready(function() {
    initializeEventListeners();
});

function initializeEventListeners() {
    // Main optimization form
    $('#optimizationForm').on('submit', function(e) {
        e.preventDefault();
        optimizeStockLevels();
    });

    // ABC Analysis button
    $('#abcAnalysisBtn').on('click', function() {
        performAbcAnalysis();
    });

    // Slow Moving button
    $('#slowMovingBtn').on('click', function() {
        identifySlowMovingItems();
    });

    // View toggle buttons
    $('button[data-view]').on('click', function() {
        const view = $(this).data('view');
        switchView(view);
        $('button[data-view]').removeClass('active');
        $(this).addClass('active');
    });

    // Calculator forms
    $('#eoqCalculatorForm').on('submit', function(e) {
        e.preventDefault();
        calculateEOQ();
    });

    $('#safetyStockCalculatorForm').on('submit', function(e) {
        e.preventDefault();
        calculateSafetyStock();
    });
}

function optimizeStockLevels() {
    const formData = {
        product_id: $('#productSelect').val(),
        location_id: $('#locationSelect').val() || null,
        service_level: parseFloat($('#serviceLevelSelect').val()),
        objective: $('#objectiveSelect').val(),
        forecast_horizon: 90,
        constraints: {
            lead_time_days: parseFloat($('#leadTimeDays').val()),
            lead_time_variability: parseFloat($('#leadTimeVariability').val()),
            supplier_capacity_monthly: parseInt($('#supplierCapacity').val()) || null,
            storage_capacity_units: parseInt($('#storageCapacity').val()) || null,
            working_capital_limit: parseFloat($('#workingCapitalLimit').val()) || null
        },
        cost_parameters: {
            holding_cost_percentage_annual: parseFloat($('#holdingCostRate').val()) / 100,
            ordering_cost_per_order: parseFloat($('#orderingCost').val()),
            stockout_cost_per_unit: parseFloat($('#stockoutCost').val()),
            storage_cost_per_unit_monthly: parseFloat($('#storageCost').val()),
            working_capital_rate_annual: parseFloat($('#capitalRate').val()) / 100
        }
    };

    showLoading(true);
    hideAllResults();

    $.ajax({
        url: '/api/stock-optimization/optimize',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            optimizationData = response;
            displayOptimizationResults(response);
            showLoading(false);
            switchView('overview');
        },
        error: function(xhr, status, error) {
            showLoading(false);
            showError('Optimization failed: ' + (xhr.responseJSON?.error || error));
        }
    });
}

function performAbcAnalysis() {
    showLoading(true);
    hideAllResults();

    $.ajax({
        url: '/api/stock-optimization/abc-analysis',
        method: 'GET',
        success: function(response) {
            displayAbcAnalysis(response.abc_analysis);
            showLoading(false);
            switchView('abc');
        },
        error: function(xhr, status, error) {
            showLoading(false);
            showError('ABC Analysis failed: ' + (xhr.responseJSON?.error || error));
        }
    });
}

function identifySlowMovingItems() {
    showLoading(true);
    hideAllResults();

    const params = new URLSearchParams({
        days_threshold: 90,
        turnover_threshold: 2.0
    });

    $.ajax({
        url: '/api/stock-optimization/slow-moving?' + params.toString(),
        method: 'GET',
        success: function(response) {
            displaySlowMovingItems(response.slow_moving_items);
            showLoading(false);
            switchView('slow-moving');
        },
        error: function(xhr, status, error) {
            showLoading(false);
            showError('Slow moving analysis failed: ' + (xhr.responseJSON?.error || error));
        }
    });
}

function displayOptimizationResults(response) {
    if (!response.optimization_results || response.optimization_results.length === 0) {
        showError('No optimization results found');
        return;
    }

    // Display KPIs
    displayKPIs(response.optimization_results);

    // Display main results table
    displayResultsTable(response.optimization_results);

    // Display detailed results
    displayDetailedResults(response.optimization_results);

    // Create charts
    createCharts(response.optimization_results);

    // Display recommendations
    displayRecommendations(response.optimization_results);

    $('#overviewResults').removeClass('d-none');
}

function displayKPIs(results) {
    const kpiHtml = results.map(result => `
        <div class="col-md-3 mb-3">
            <div class="card border-0 bg-light">
                <div class="card-body text-center">
                    <h3 class="text-primary">${result.optimal_stock_level}</h3>
                    <p class="mb-1">Optimal Stock</p>
                    <small class="text-muted">${result.location_id || 'All Locations'}</small>
                </div>
            </div>
        </div>
    `).join('');

    $('#kpiCards').html(kpiHtml);
}

function displayResultsTable(results) {
    const tableHtml = results.map(result => `
        <tr>
            <td>${result.location_id || 'N/A'}</td>
            <td><span class="badge bg-secondary">${result.current_stock}</span></td>
            <td><span class="badge bg-primary">${result.optimal_stock_level}</span></td>
            <td><span class="badge bg-warning text-dark">${result.reorder_point}</span></td>
            <td><span class="badge bg-info">${result.reorder_quantity}</span></td>
            <td><span class="badge bg-success">${result.safety_stock}</span></td>
            <td>${(result.service_level_achieved * 100).toFixed(1)}%</td>
            <td>$${result.total_annual_cost.toFixed(2)}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="showLocationDetails('${result.location_id}')">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        </tr>
    `).join('');

    $('#optimizationTable tbody').html(tableHtml);
}

function displayDetailedResults(results) {
    if (results.length > 0) {
        const result = results[0]; // Show details for first result
        
        // Cost breakdown
        const costHtml = Object.entries(result.cost_breakdown).map(([key, value]) => `
            <div class="row mb-2">
                <div class="col-8">${formatCostLabel(key)}</div>
                <div class="col-4 text-end">$${value.toFixed(2)}</div>
            </div>
        `).join('');
        $('#costBreakdown').html(costHtml);

        // Risk metrics
        const riskHtml = Object.entries(result.risk_metrics).map(([key, value]) => `
            <div class="row mb-2">
                <div class="col-8">${formatRiskLabel(key)}</div>
                <div class="col-4 text-end">
                    <span class="badge bg-${getRiskColor(value)}">${formatRiskValue(key, value)}</span>
                </div>
            </div>
        `).join('');
        $('#riskMetrics').html(riskHtml);
    }
}

function displayRecommendations(results) {
    if (results.length > 0) {
        const recommendations = results[0].recommendations || [];
        
        const immediateActions = recommendations.filter(r => r.includes('Immediate') || r.includes('reorder'));
        const optimizations = recommendations.filter(r => r.includes('Increase') || r.includes('reduce') || r.includes('Consider'));
        const riskMitigation = recommendations.filter(r => r.includes('risk') || r.includes('safety') || r.includes('forecast'));

        $('#immediateActions').html(immediateActions.map(action => `<li><i class="fas fa-exclamation-circle text-warning me-2"></i>${action}</li>`).join(''));
        $('#optimizationSuggestions').html(optimizations.map(action => `<li><i class="fas fa-lightbulb text-info me-2"></i>${action}</li>`).join(''));
        $('#riskMitigation').html(riskMitigation.map(action => `<li><i class="fas fa-shield-alt text-success me-2"></i>${action}</li>`).join(''));
    }
}

function displayAbcAnalysis(analysis) {
    if (!analysis.products) {
        showError('No ABC analysis data available');
        return;
    }

    const productsByCategory = {
        A: analysis.products.filter(p => p.abc_category === 'A'),
        B: analysis.products.filter(p => p.abc_category === 'B'),
        C: analysis.products.filter(p => p.abc_category === 'C')
    };

    ['A', 'B', 'C'].forEach(category => {
        const products = productsByCategory[category];
        const html = `
            <h6>${products.length} Products (${(products.length / analysis.products.length * 100).toFixed(1)}%)</h6>
            <ul class="list-unstyled">
                ${products.slice(0, 5).map(p => `
                    <li class="mb-1">
                        <small>${p.product_name}</small><br>
                        <span class="badge bg-light text-dark">$${p.annual_value.toFixed(0)}</span>
                    </li>
                `).join('')}
                ${products.length > 5 ? `<li class="text-muted"><small>... and ${products.length - 5} more</small></li>` : ''}
            </ul>
        `;
        $(`#category${category}`).html(html);
    });

    $('#abcResults').removeClass('d-none');
}

function displaySlowMovingItems(items) {
    if (!items || items.length === 0) {
        $('#slowMovingResults').html('<p class="text-center text-muted py-4">No slow-moving items found</p>');
        $('#slowMovingResults').removeClass('d-none');
        return;
    }

    const tableHtml = items.map(item => `
        <tr>
            <td>${item.product_name}</td>
            <td>${item.location_name}</td>
            <td><span class="badge bg-secondary">${item.available_quantity}</span></td>
            <td><span class="badge bg-warning text-dark">${item.average_age_days || 'N/A'}</span></td>
            <td>${(item.turnover_rate_annual || 0).toFixed(2)}</td>
            <td>$${item.total_value.toFixed(2)}</td>
            <td>
                <span class="badge bg-${item.obsolescence_risk_score > 0.7 ? 'danger' : item.obsolescence_risk_score > 0.4 ? 'warning' : 'success'}">
                    ${(item.obsolescence_risk_score * 100).toFixed(0)}%
                </span>
            </td>
            <td>
                <small>${item.recommendations.slice(0, 2).join(', ')}</small>
            </td>
        </tr>
    `).join('');

    $('#slowMovingTable tbody').html(tableHtml);
    $('#slowMovingResults').removeClass('d-none');
}

function createCharts(results) {
    if (results.length === 0) return;

    const ctx1 = document.getElementById('stockLevelChart').getContext('2d');
    const ctx2 = document.getElementById('costAnalysisChart').getContext('2d');

    // Stock Level Chart
    charts.stockLevel = new Chart(ctx1, {
        type: 'bar',
        data: {
            labels: results.map(r => r.location_id || 'Location'),
            datasets: [{
                label: 'Current Stock',
                data: results.map(r => r.current_stock),
                backgroundColor: 'rgba(108, 117, 125, 0.5)',
                borderColor: 'rgba(108, 117, 125, 1)',
                borderWidth: 1
            }, {
                label: 'Optimal Stock',
                data: results.map(r => r.optimal_stock_level),
                backgroundColor: 'rgba(13, 110, 253, 0.5)',
                borderColor: 'rgba(13, 110, 253, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Current vs Optimal Stock Levels'
                }
            }
        }
    });

    // Cost Analysis Chart
    if (results[0].cost_breakdown) {
        const costData = results[0].cost_breakdown;
        const labels = Object.keys(costData).map(formatCostLabel);
        const data = Object.values(costData);

        charts.costAnalysis = new Chart(ctx2, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.5)',
                        'rgba(54, 162, 235, 0.5)',
                        'rgba(255, 205, 86, 0.5)',
                        'rgba(75, 192, 192, 0.5)',
                        'rgba(153, 102, 255, 0.5)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Cost Breakdown'
                    }
                }
            }
        });
    }
}

function calculateEOQ() {
    const formData = {
        annual_demand: parseFloat($('#eoqAnnualDemand').val()),
        ordering_cost: parseFloat($('#eoqOrderingCost').val()),
        holding_cost_rate: parseFloat($('#eoqHoldingRate').val()) / 100,
        unit_cost: parseFloat($('#eoqUnitCost').val())
    };

    $.ajax({
        url: '/api/stock-optimization/eoq-calculator',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            const result = response.eoq_calculation;
            $('#eoqResult').html(`
                <div class="alert alert-success">
                    <h6>EOQ Results:</h6>
                    <p><strong>Optimal Order Quantity:</strong> ${result.eoq} units</p>
                    <p><strong>Total Annual Cost:</strong> $${result.total_cost.toFixed(2)}</p>
                    <p><strong>Order Frequency:</strong> Every ${result.order_frequency_days.toFixed(0)} days</p>
                </div>
            `);
        },
        error: function(xhr) {
            $('#eoqResult').html(`<div class="alert alert-danger">Error: ${xhr.responseJSON?.error || 'Calculation failed'}</div>`);
        }
    });
}

function calculateSafetyStock() {
    const formData = {
        demand_mean: parseFloat($('#ssDemandMean').val()),
        demand_std: parseFloat($('#ssDemandStd').val()),
        lead_time_days: parseFloat($('#ssLeadTime').val()),
        lead_time_variability: parseFloat($('#ssLeadTimeVar').val()),
        service_level: parseFloat($('#ssServiceLevel').val())
    };

    $.ajax({
        url: '/api/stock-optimization/safety-stock-calculator',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            const result = response.safety_stock_calculation;
            $('#safetyStockResult').html(`
                <div class="alert alert-success">
                    <h6>Safety Stock Results:</h6>
                    <p><strong>Safety Stock:</strong> ${result.safety_stock} units</p>
                    <p><strong>Service Level Achieved:</strong> ${(result.service_level_achieved * 100).toFixed(1)}%</p>
                    <p><strong>Z-Score Used:</strong> ${result.z_score.toFixed(2)}</p>
                </div>
            `);
        },
        error: function(xhr) {
            $('#safetyStockResult').html(`<div class="alert alert-danger">Error: ${xhr.responseJSON?.error || 'Calculation failed'}</div>`);
        }
    });
}

// Utility functions
function switchView(view) {
    hideAllResults();
    
    switch(view) {
        case 'overview':
            $('#overviewResults').removeClass('d-none');
            break;
        case 'details':
            $('#detailResults').removeClass('d-none');
            break;
        case 'charts':
            $('#chartResults').removeClass('d-none');
            break;
        case 'recommendations':
            $('#recommendationResults').removeClass('d-none');
            break;
        case 'abc':
            $('#abcResults').removeClass('d-none');
            break;
        case 'slow-moving':
            $('#slowMovingResults').removeClass('d-none');
            break;
    }
}

function hideAllResults() {
    $('#initialState, #overviewResults, #detailResults, #chartResults, #recommendationResults, #abcResults, #slowMovingResults').addClass('d-none');
}

function showLoading(show) {
    if (show) {
        $('#loadingSpinner').removeClass('d-none');
        $('#optimizeBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Optimizing...');
    } else {
        $('#loadingSpinner').addClass('d-none');
        $('#optimizeBtn').prop('disabled', false).html('<i class="fas fa-cog me-1"></i>Optimize Stock Levels');
    }
}

function showError(message) {
    $('#initialState').html(`
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
        </div>
    `).removeClass('d-none');
}

function formatCostLabel(key) {
    return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function formatRiskLabel(key) {
    return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function formatRiskValue(key, value) {
    if (key.includes('probability') || key.includes('risk')) {
        return (value * 100).toFixed(1) + '%';
    }
    return value.toFixed(2);
}

function getRiskColor(value) {
    if (value > 0.7) return 'danger';
    if (value > 0.4) return 'warning';
    return 'success';
}

function showLocationDetails(locationId) {
    // Implementation for showing detailed location information
    alert('Location details for: ' + locationId);
}

// Add floating action button for calculators
$(document).ready(function() {
    $('body').append(`
        <button class="btn btn-primary btn-lg rounded-circle position-fixed" 
                style="bottom: 20px; right: 20px; z-index: 1000;"
                data-bs-toggle="modal" data-bs-target="#calculatorsModal">
            <i class="fas fa-calculator"></i>
        </button>
    `);
});
</script>
{% endblock %}