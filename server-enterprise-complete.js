/**
 * SENTIA MANUFACTURING DASHBOARD - ENTERPRISE SERVER
 * Serves the React application with proper static file handling
 */

import express from 'express';
import cors from 'cors';
import path from 'path';
import { fileURLToPath } from 'url';
import dotenv from 'dotenv';
import enhancedForecastingRouter from './server/api/enhanced-forecasting.js';

// Load environment variables
dotenv.config();

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const PORT = process.env.PORT || 10000;

// Enable CORS
app.use(cors());

// Parse JSON bodies
app.use(express.json());

// Serve static files from the dist directory
app.use(express.static(path.join(__dirname, 'dist')));

// Health check endpoint
app.get('/health', (req, res) => {
  res.status(200).json({ 
    status: 'healthy', 
    timestamp: new Date().toISOString(),
    service: 'Sentia Manufacturing Dashboard',
    version: '1.0.0'
  });
});

// API endpoints for MCP integration (placeholder)
app.get('/api/status', (req, res) => {
  res.json({
    mcp_servers: {
      xero: 'error',
      shopify: 'connected',
      unleashed: 'connected',
      huggingface: 'connected'
    },
    working_capital: 'Â£170.3K',
    revenue: 'Â£3.17M',
    units_forecast: '245K'
  });
});

// Authentication endpoints
app.get('/api/auth/me', async (req, res) => {
  // This would integrate with Clerk in production
  res.json({
    user: {
      id: 'user_123',
      email: 'admin@sentia.com',
      role: 'admin',
      permissions: ['all']
    }
  });
});

// Dashboard Summary endpoint - BULLETPROOF JSON ONLY
app.get('/api/dashboard/summary', async (req, res) => {
  try {
    const dashboardData = {
      revenue: {
        monthly: 2543000,
        quarterly: 7850000,
        yearly: 32400000,
        growth: 12.3
      },
      workingCapital: {
        current: 1945000,
        ratio: 2.76,
        cashFlow: 850000,
        daysReceivable: 45
      },
      production: {
        efficiency: 94.2,
        unitsProduced: 12543,
        defectRate: 0.8,
        oeeScore: 87.5
      },
      inventory: {
        value: 1234000,
        turnover: 4.2,
        skuCount: 342,
        lowStock: 8
      },
      financial: {
        grossMargin: 42.3,
        netMargin: 18.7,
        ebitda: 485000,
        roi: 23.4
      },
      timestamp: new Date().toISOString(),
      dataSource: 'enterprise-complete-api'
    };
    res.json(dashboardData);
  } catch (error) {
    console.error('Dashboard summary API error', error);
    res.status(500).json({ error: 'Failed to fetch dashboard summary' });
  }
});

// Working Capital API endpoints
app.get('/api/working-capital/overview', async (req, res) => {
  try {
    // Real database query would go here
    const data = {
      cashFlow: {
        current: 2450000,
        projected: 2850000,
        change: 16.3
      },
      receivables: {
        current: 1850000,
        dso: 42,
        overdue: 320000
      },
      payables: {
        current: 980000,
        dpo: 38,
        upcoming: 450000
      },
      inventory: {
        value: 3200000,
        turnover: 8.2,
        daysOnHand: 44
      }
    };
    res.json(data);
  } catch (error) {
    console.error('Working capital API error', error);
    res.status(500).json({ error: 'Failed to fetch working capital data' });
  }
});

// What-If Analysis API endpoints
app.post('/api/what-if/scenario', async (req, res) => {
  try {
    const { parameters } = req.body;
    // Process scenario analysis
    const results = {
      impact: {
        revenue: parameters.revenueGrowth || 10,
        costs: parameters.costReduction || 5,
        cashFlow: parameters.cashFlowImprovement || 15
      },
      recommendations: [
        'Optimize inventory levels',
        'Improve collection processes',
        'Negotiate better payment terms'
      ]
    };
    res.json(results);
  } catch (error) {
    console.error('What-if API error', error);
    res.status(500).json({ error: 'Failed to process scenario' });
  }
});

// Production API endpoints
app.get('/api/production/jobs', async (req, res) => {
  try {
    // In production, this would query the actual database
    const jobs = [
      {
        id: 'JOB-001',
        product: 'Product A',
        quantity: 1000,
        status: 'in_progress',
        completion: 65
      },
      {
        id: 'JOB-002',
        product: 'Product B',
        quantity: 500,
        status: 'scheduled',
        completion: 0
      }
    ];
    res.json(jobs);
  } catch (error) {
    console.error('Production API error', error);
    res.status(500).json({ error: 'Failed to fetch production jobs' });
  }
});

// Quality Control API endpoints
app.get('/api/quality/metrics', async (req, res) => {
  try {
    const metrics = {
      defectRate: 0.018,
      firstPassYield: 0.965,
      customerComplaints: 3,
      inspectionsPassed: 487,
      inspectionsFailed: 13
    };
    res.json(metrics);
  } catch (error) {
    console.error('Quality API error', error);
    res.status(500).json({ error: 'Failed to fetch quality metrics' });
  }
});

// Inventory API endpoints
app.get('/api/inventory/levels', async (req, res) => {
  try {
    const inventory = {
      totalValue: 3200000,
      items: [
        {
          sku: 'RAW-001',
          name: 'Raw Material A',
          quantity: 5000,
          unit: 'kg',
          value: 150000
        },
        {
          sku: 'RAW-002',
          name: 'Raw Material B',
          quantity: 3000,
          unit: 'liters',
          value: 90000
        }
      ],
      lowStock: 5,
      outOfStock: 1
    };
    res.json(inventory);
  } catch (error) {
    console.error('Inventory API error', error);
    res.status(500).json({ error: 'Failed to fetch inventory levels' });
  }
});

// Forecasting API endpoints
app.get('/api/forecasting/demand', async (req, res) => {
  try {
    const forecast = {
      nextMonth: 12500,
      nextQuarter: 38000,
      accuracy: 0.89,
      trend: 'increasing',
      seasonalFactors: {
        january: 0.95,
        february: 0.98,
        march: 1.05
      }
    };
    res.json(forecast);
  } catch (error) {
    console.error('Forecasting API error', error);
    res.status(500).json({ error: 'Failed to generate forecast' });
  }
});

// Analytics API endpoints
app.get('/api/analytics/kpis', async (req, res) => {
  try {
    const kpis = {
      revenue: {
        value: 8500000,
        target: 10000000,
        achievement: 0.85
      },
      efficiency: {
        oee: 0.78,
        utilization: 0.82,
        productivity: 0.91
      },
      quality: {
        defectRate: 0.018,
        customerSatisfaction: 0.92,
        onTimeDelivery: 0.94
      }
    };
    res.json(kpis);
  } catch (error) {
    console.error('Analytics API error', error);
    res.status(500).json({ error: 'Failed to fetch KPIs' });
  }
});

// AI Analytics endpoints (fallback - MCP integration would go here)
app.post('/api/ai/analyze', async (req, res) => {
  try {
    const { query, context } = req.body;
    // Fallback response when MCP not connected
    res.json({
      analysis: 'AI analysis unavailable - MCP not connected',
      recommendations: [],
      confidence: 0
    });
  } catch (error) {
    console.error('AI API error', error);
    res.status(500).json({ error: 'Failed to process AI analysis' });
  }
});

// MCP Tools API endpoints
app.get('/api/mcp/tools', async (req, res) => {
  try {
    res.json({ tools: [], message: 'MCP not connected' });
  } catch (error) {
    console.error('MCP API error', error);
    res.status(500).json({ error: 'Failed to list MCP tools' });
  }
});

// Enhanced Forecasting API Routes
app.use('/api/forecasting/enhanced', enhancedForecastingRouter);

// AI Status endpoint for enhanced forecasting
app.get('/api/ai/status', (req, res) => {
  res.json({
    models: {
      openai: !!process.env.OPENAI_API_KEY,
      claude: !!process.env.ANTHROPIC_API_KEY
    },
    ready: !!(process.env.OPENAI_API_KEY && process.env.ANTHROPIC_API_KEY),
    capabilities: [
      'dual_model_forecasting',
      '365_day_horizon',
      'ensemble_prediction',
      'business_intelligence'
    ]
  });
});

// Serve the React app for all other routes
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, 'dist', 'index.html'));
});

// Start server
app.listen(PORT, '0.0.0.0', () => {
  console.log(`ðŸš€ Sentia Manufacturing Dashboard running on port ${PORT}`);
  console.log(`ðŸ“Š Environment: ${process.env.NODE_ENV || 'development'}`);
  console.log(`ðŸ”— Health check: http://localhost:${PORT}/health`);
});
