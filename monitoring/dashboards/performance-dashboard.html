<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sentia Performance Monitoring Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .metric-card {
      transition: all 0.3s ease;
    }
    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .status-healthy { color: #10b981; }
    .status-warning { color: #f59e0b; }
    .status-critical { color: #ef4444; }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Header -->
  <header class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-800 rounded-lg flex items-center justify-center">
            <span class="text-white font-bold text-xl">S</span>
          </div>
          <h1 class="text-2xl font-bold text-gray-900">Performance Monitoring</h1>
        </div>
        <div class="flex items-center space-x-4">
          <select id="environmentSelect" class="px-3 py-2 border rounded-lg">
            <option value="production">Production</option>
            <option value="testing">Testing</option>
            <option value="development">Development</option>
          </select>
          <button onclick="refreshData()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Refresh
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Health Status -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-900">System Health</h2>
        <div class="flex items-center space-x-2">
          <span id="healthScore" class="text-3xl font-bold">--</span>
          <span class="text-gray-500">/100</span>
        </div>
      </div>
      <div class="grid grid-cols-4 gap-4">
        <div class="text-center">
          <div id="statusAPI" class="w-4 h-4 rounded-full mx-auto mb-2"></div>
          <p class="text-sm text-gray-600">API</p>
        </div>
        <div class="text-center">
          <div id="statusDB" class="w-4 h-4 rounded-full mx-auto mb-2"></div>
          <p class="text-sm text-gray-600">Database</p>
        </div>
        <div class="text-center">
          <div id="statusCache" class="w-4 h-4 rounded-full mx-auto mb-2"></div>
          <p class="text-sm text-gray-600">Cache</p>
        </div>
        <div class="text-center">
          <div id="statusQueue" class="w-4 h-4 rounded-full mx-auto mb-2"></div>
          <p class="text-sm text-gray-600">Queue</p>
        </div>
      </div>
    </div>

    <!-- Key Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Response Time -->
      <div class="metric-card bg-white rounded-lg shadow-md p-6">
        <h3 class="text-sm font-medium text-gray-500 mb-2">Avg Response Time</h3>
        <div class="flex items-baseline">
          <span id="avgResponseTime" class="text-3xl font-bold text-gray-900">--</span>
          <span class="ml-2 text-sm text-gray-500">ms</span>
        </div>
        <div class="mt-2 flex items-center text-sm">
          <span id="responseTimeTrend" class="text-gray-500">--</span>
        </div>
      </div>

      <!-- Error Rate -->
      <div class="metric-card bg-white rounded-lg shadow-md p-6">
        <h3 class="text-sm font-medium text-gray-500 mb-2">Error Rate</h3>
        <div class="flex items-baseline">
          <span id="errorRate" class="text-3xl font-bold text-gray-900">--</span>
          <span class="ml-2 text-sm text-gray-500">%</span>
        </div>
        <div class="mt-2 flex items-center text-sm">
          <span id="errorCount" class="text-gray-500">-- errors today</span>
        </div>
      </div>

      <!-- Requests/sec -->
      <div class="metric-card bg-white rounded-lg shadow-md p-6">
        <h3 class="text-sm font-medium text-gray-500 mb-2">Throughput</h3>
        <div class="flex items-baseline">
          <span id="requestsPerSec" class="text-3xl font-bold text-gray-900">--</span>
          <span class="ml-2 text-sm text-gray-500">req/s</span>
        </div>
        <div class="mt-2 flex items-center text-sm">
          <span id="totalRequests" class="text-gray-500">-- total</span>
        </div>
      </div>

      <!-- Uptime -->
      <div class="metric-card bg-white rounded-lg shadow-md p-6">
        <h3 class="text-sm font-medium text-gray-500 mb-2">Uptime</h3>
        <div class="flex items-baseline">
          <span id="uptime" class="text-3xl font-bold text-gray-900">--</span>
          <span class="ml-2 text-sm text-gray-500">%</span>
        </div>
        <div class="mt-2 flex items-center text-sm">
          <span id="uptimeDuration" class="text-gray-500">--</span>
        </div>
      </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Response Time Chart -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Response Time (Last Hour)</h3>
        <canvas id="responseTimeChart"></canvas>
      </div>

      <!-- Request Volume Chart -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Request Volume (Last Hour)</h3>
        <canvas id="requestVolumeChart"></canvas>
      </div>
    </div>

    <!-- Resource Usage -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Resource Usage</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- CPU Usage -->
        <div>
          <div class="flex justify-between mb-2">
            <span class="text-sm font-medium text-gray-700">CPU Usage</span>
            <span id="cpuPercent" class="text-sm font-semibold">--%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="cpuBar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
          </div>
        </div>

        <!-- Memory Usage -->
        <div>
          <div class="flex justify-between mb-2">
            <span class="text-sm font-medium text-gray-700">Memory Usage</span>
            <span id="memoryPercent" class="text-sm font-semibold">--%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="memoryBar" class="bg-green-600 h-2 rounded-full" style="width: 0%"></div>
          </div>
        </div>

        <!-- Disk Usage -->
        <div>
          <div class="flex justify-between mb-2">
            <span class="text-sm font-medium text-gray-700">Disk Usage</span>
            <span id="diskPercent" class="text-sm font-semibold">--%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="diskBar" class="bg-purple-600 h-2 rounded-full" style="width: 0%"></div>
          </div>
        </div>

        <!-- Network I/O -->
        <div>
          <div class="flex justify-between mb-2">
            <span class="text-sm font-medium text-gray-700">Network I/O</span>
            <span id="networkIO" class="text-sm font-semibold">-- MB/s</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="networkBar" class="bg-orange-600 h-2 rounded-full" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Alerts -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Recent Alerts</h3>
      <div id="alertsList" class="space-y-3">
        <!-- Alerts will be populated here -->
      </div>
    </div>
  </main>

  <script>
    // Configuration
    const API_BASE = '/api/monitoring';
    const REFRESH_INTERVAL = 10000; // 10 seconds

    // Chart instances
    let responseTimeChart = null;
    let requestVolumeChart = null;

    // Initialize charts
    function initCharts() {
      // Response Time Chart
      const rtCtx = document.getElementById('responseTimeChart').getContext('2d');
      responseTimeChart = new Chart(rtCtx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'p50',
            data: [],
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4
          }, {
            label: 'p95',
            data: [],
            borderColor: 'rgb(251, 146, 60)',
            backgroundColor: 'rgba(251, 146, 60, 0.1)',
            tension: 0.4
          }, {
            label: 'p99',
            data: [],
            borderColor: 'rgb(239, 68, 68)',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Response Time (ms)'
              }
            }
          }
        }
      });

      // Request Volume Chart
      const rvCtx = document.getElementById('requestVolumeChart').getContext('2d');
      requestVolumeChart = new Chart(rvCtx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Requests',
            data: [],
            backgroundColor: 'rgba(34, 197, 94, 0.8)',
            borderColor: 'rgb(34, 197, 94)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Requests per minute'
              }
            }
          }
        }
      });
    }

    // Fetch and update data
    async function fetchData() {
      try {
        const environment = document.getElementById('environmentSelect').value;
        const response = await fetch(`${API_BASE}/metrics?env=${environment}`);
        const data = await response.json();

        updateMetrics(data);
        updateCharts(data);
        updateAlerts(data.alerts);
      } catch (error) {
        console.error('Failed to fetch metrics:', error);
      }
    }

    // Update metric displays
    function updateMetrics(data) {
      // Health Score
      const healthScore = data.health || 0;
      document.getElementById('healthScore').textContent = healthScore;
      document.getElementById('healthScore').className = `text-3xl font-bold ${
        healthScore >= 90 ? 'text-green-600' :
        healthScore >= 70 ? 'text-yellow-600' :
        'text-red-600'
      }`;

      // Service Status
      updateStatus('statusAPI', data.services?.api);
      updateStatus('statusDB', data.services?.database);
      updateStatus('statusCache', data.services?.cache);
      updateStatus('statusQueue', data.services?.queue);

      // Key Metrics
      document.getElementById('avgResponseTime').textContent = data.responseTime?.avg || '--';
      document.getElementById('errorRate').textContent = (data.errorRate * 100).toFixed(2);
      document.getElementById('requestsPerSec').textContent = data.requestsPerSecond?.toFixed(1) || '--';
      document.getElementById('uptime').textContent = data.uptime?.percent || '--';

      // Additional Info
      document.getElementById('errorCount').textContent = `${data.errorCount || 0} errors today`;
      document.getElementById('totalRequests').textContent = `${data.totalRequests || 0} total`;
      document.getElementById('uptimeDuration').textContent = formatUptime(data.uptime?.seconds);

      // Resource Usage
      updateResourceBar('cpu', data.resources?.cpu);
      updateResourceBar('memory', data.resources?.memory);
      updateResourceBar('disk', data.resources?.disk);
      document.getElementById('networkIO').textContent = `${(data.resources?.network || 0).toFixed(1)} MB/s`;
    }

    // Update service status indicator
    function updateStatus(elementId, status) {
      const element = document.getElementById(elementId);
      if (status === 'healthy') {
        element.className = 'w-4 h-4 rounded-full mx-auto mb-2 bg-green-500';
      } else if (status === 'degraded') {
        element.className = 'w-4 h-4 rounded-full mx-auto mb-2 bg-yellow-500';
      } else {
        element.className = 'w-4 h-4 rounded-full mx-auto mb-2 bg-red-500';
      }
    }

    // Update resource usage bar
    function updateResourceBar(type, value) {
      const percent = value || 0;
      document.getElementById(`${type}Percent`).textContent = `${percent}%`;
      document.getElementById(`${type}Bar`).style.width = `${percent}%`;

      // Change color based on usage
      const bar = document.getElementById(`${type}Bar`);
      if (percent > 80) {
        bar.className = bar.className.replace(/bg-\w+-600/, 'bg-red-600');
      } else if (percent > 60) {
        bar.className = bar.className.replace(/bg-\w+-600/, 'bg-yellow-600');
      }
    }

    // Update charts with new data
    function updateCharts(data) {
      if (!data.timeSeries) return;

      const labels = data.timeSeries.map(t => new Date(t.timestamp).toLocaleTimeString());

      // Update Response Time Chart
      responseTimeChart.data.labels = labels;
      responseTimeChart.data.datasets[0].data = data.timeSeries.map(t => t.p50);
      responseTimeChart.data.datasets[1].data = data.timeSeries.map(t => t.p95);
      responseTimeChart.data.datasets[2].data = data.timeSeries.map(t => t.p99);
      responseTimeChart.update();

      // Update Request Volume Chart
      requestVolumeChart.data.labels = labels;
      requestVolumeChart.data.datasets[0].data = data.timeSeries.map(t => t.requests);
      requestVolumeChart.update();
    }

    // Update alerts list
    function updateAlerts(alerts) {
      const alertsList = document.getElementById('alertsList');

      if (!alerts || alerts.length === 0) {
        alertsList.innerHTML = '<p class="text-gray-500 text-sm">No recent alerts</p>';
        return;
      }

      alertsList.innerHTML = alerts.map(alert => `
        <div class="flex items-start space-x-3 p-3 rounded-lg ${
          alert.severity === 'critical' ? 'bg-red-50' :
          alert.severity === 'warning' ? 'bg-yellow-50' :
          'bg-blue-50'
        }">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 ${
              alert.severity === 'critical' ? 'text-red-600' :
              alert.severity === 'warning' ? 'text-yellow-600' :
              'text-blue-600'
            }" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
          </div>
          <div class="flex-1">
            <p class="text-sm font-medium text-gray-900">${alert.title}</p>
            <p class="text-sm text-gray-500">${alert.message}</p>
            <p class="text-xs text-gray-400 mt-1">${new Date(alert.timestamp).toLocaleString()}</p>
          </div>
        </div>
      `).join('');
    }

    // Format uptime duration
    function formatUptime(seconds) {
      if (!seconds) return '--';
      const days = Math.floor(seconds / 86400);
      const hours = Math.floor((seconds % 86400) / 3600);
      return `${days}d ${hours}h`;
    }

    // Refresh data
    function refreshData() {
      fetchData();
    }

    // Auto-refresh
    let refreshInterval;
    function startAutoRefresh() {
      refreshInterval = setInterval(fetchData, REFRESH_INTERVAL);
    }

    function stopAutoRefresh() {
      clearInterval(refreshInterval);
    }

    // Initialize on load
    window.addEventListener('load', () => {
      initCharts();
      fetchData();
      startAutoRefresh();
    });

    // Clean up on unload
    window.addEventListener('beforeunload', () => {
      stopAutoRefresh();
    });
  </script>
</body>
</html>