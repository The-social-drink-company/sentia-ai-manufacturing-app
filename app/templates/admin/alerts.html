{% extends "base.html" %}

{% block title %}System Alerts{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-bell"></i> System Alerts</h1>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="markAllRead()">
                        <i class="fas fa-check"></i> Mark All Read
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="clearDismissed()">
                        <i class="fas fa-trash"></i> Clear Dismissed
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Statistics -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Alerts</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ alert_stats.total }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-bell fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Unread</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ alert_stats.unread }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-bell-slash fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Critical</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ alert_stats.critical }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Today</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ alert_stats.today }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-day fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-3">
                    <label for="alert_type" class="form-label">Alert Type</label>
                    <select class="form-select" id="alert_type" name="type">
                        <option value="all" {{ 'selected' if alert_type == 'all' }}>All Types</option>
                        <option value="info" {{ 'selected' if alert_type == 'info' }}>Info</option>
                        <option value="warning" {{ 'selected' if alert_type == 'warning' }}>Warning</option>
                        <option value="error" {{ 'selected' if alert_type == 'error' }}>Error</option>
                        <option value="success" {{ 'selected' if alert_type == 'success' }}>Success</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="status" class="form-label">Status</label>
                    <select class="form-select" id="status" name="status">
                        <option value="all" {{ 'selected' if status == 'all' }}>All Status</option>
                        <option value="unread" {{ 'selected' if status == 'unread' }}>Unread</option>
                        <option value="read" {{ 'selected' if status == 'read' }}>Read</option>
                        <option value="dismissed" {{ 'selected' if status == 'dismissed' }}>Dismissed</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="date_range" class="form-label">Date Range</label>
                    <select class="form-select" id="date_range" name="date_range">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Filter</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Alerts List -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">System Alerts</h6>
        </div>
        <div class="card-body">
            {% if alerts.items %}
                {% for alert in alerts.items %}
                <div class="alert alert-{{ 'danger' if alert.alert_type.value == 'error' else 
                                          'warning' if alert.alert_type.value == 'warning' else
                                          'success' if alert.alert_type.value == 'success' else 'info' }} 
                           {{ 'alert-dismissible' if alert.status.value == 'unread' else '' }} 
                           fade show mb-3" role="alert">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="alert-heading">
                                <i class="fas fa-{{ 'exclamation-circle' if alert.alert_type.value == 'error' else
                                                  'exclamation-triangle' if alert.alert_type.value == 'warning' else
                                                  'check-circle' if alert.alert_type.value == 'success' else 'info-circle' }}"></i>
                                {{ alert.title }}
                                {% if alert.severity >= 3 %}
                                    <span class="badge badge-danger ms-2">High Priority</span>
                                {% endif %}
                            </h6>
                            <p class="mb-2">{{ alert.message }}</p>
                            <div class="small text-muted">
                                <span><i class="fas fa-clock"></i> {{ alert.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
                                {% if alert.source %}
                                    <span class="ms-3"><i class="fas fa-tag"></i> {{ alert.source }}</span>
                                {% endif %}
                                <span class="ms-3">
                                    <i class="fas fa-{{ 'eye-slash' if alert.status.value == 'unread' else 
                                                       'eye' if alert.status.value == 'read' else 'times' }}"></i>
                                    {{ alert.status.value.title() }}
                                </span>
                            </div>
                        </div>
                        <div class="ms-3">
                            <div class="btn-group-vertical btn-group-sm" role="group">
                                {% if alert.status.value == 'unread' %}
                                    <button type="button" class="btn btn-outline-primary" 
                                            onclick="markAlertRead({{ alert.id }})" title="Mark as Read">
                                        <i class="fas fa-check"></i>
                                    </button>
                                {% endif %}
                                {% if alert.status.value != 'dismissed' %}
                                    <button type="button" class="btn btn-outline-secondary" 
                                            onclick="dismissAlert({{ alert.id }})" title="Dismiss">
                                        <i class="fas fa-times"></i>
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- Pagination -->
                {% if alerts.pages > 1 %}
                <nav aria-label="Alerts pagination">
                    <ul class="pagination justify-content-center">
                        {% if alerts.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('admin.system_alerts', page=alerts.prev_num, type=alert_type, status=status) }}">Previous</a>
                            </li>
                        {% endif %}
                        
                        {% for page_num in alerts.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != alerts.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('admin.system_alerts', page=page_num, type=alert_type, status=status) }}">{{ page_num }}</a>
                                    </li>
                                {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                {% endif %}
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if alerts.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('admin.system_alerts', page=alerts.next_num, type=alert_type, status=status) }}">Next</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

            {% else %}
                <div class="text-center">
                    <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No alerts found matching your criteria.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function markAlertRead(alertId) {
    fetch(`/admin/alerts/${alertId}/mark-read`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to mark alert as read');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to mark alert as read');
    });
}

function dismissAlert(alertId) {
    if (confirm('Are you sure you want to dismiss this alert?')) {
        fetch(`/admin/alerts/${alertId}/dismiss`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to dismiss alert');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to dismiss alert');
        });
    }
}

function markAllRead() {
    if (confirm('Mark all unread alerts as read?')) {
        fetch('/admin/alerts/mark-all-read', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to mark all alerts as read');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to mark all alerts as read');
        });
    }
}

function clearDismissed() {
    if (confirm('Permanently delete all dismissed alerts? This cannot be undone.')) {
        fetch('/admin/alerts/clear-dismissed', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to clear dismissed alerts');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to clear dismissed alerts');
        });
    }
}

// Auto-refresh alerts every 60 seconds
setInterval(() => {
    location.reload();
}, 60000);
</script>
{% endblock %}