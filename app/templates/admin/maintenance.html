{% extends "base.html" %}

{% block title %}Maintenance Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-tools"></i> Maintenance Management</h1>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newMaintenanceModal">
                    <i class="fas fa-plus"></i> Schedule Maintenance
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6">
            <div class="card bg-primary text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">System Status</div>
                            <div class="h6 mb-0 font-weight-bold">
                                {% set maintenance_active = windows|selectattr('maintenance_mode_enabled', 'equalto', true)|list %}
                                {% if maintenance_active %}
                                    MAINTENANCE MODE
                                {% else %}
                                    OPERATIONAL
                                {% endif %}
                            </div>
                        </div>
                        <div>
                            <i class="fas fa-server fa-2x text-white-300"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex align-items-center justify-content-between">
                    {% if maintenance_active %}
                        <button class="btn btn-sm btn-light" onclick="disableMaintenanceMode()">Exit Maintenance</button>
                    {% else %}
                        <button class="btn btn-sm btn-warning" onclick="enableMaintenanceMode()">Enable Maintenance</button>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card bg-success text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">Database</div>
                            <div class="h6 mb-0 font-weight-bold">HEALTHY</div>
                        </div>
                        <div>
                            <i class="fas fa-database fa-2x text-white-300"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex align-items-center justify-content-between">
                    <button class="btn btn-sm btn-light" onclick="testDatabase()">Test Connection</button>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card bg-info text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">Backup System</div>
                            <div class="h6 mb-0 font-weight-bold">READY</div>
                        </div>
                        <div>
                            <i class="fas fa-save fa-2x text-white-300"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex align-items-center justify-content-between">
                    <button class="btn btn-sm btn-light" onclick="initiateBackup()">Start Backup</button>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6">
            <div class="card bg-warning text-white mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <div class="text-xs font-weight-bold text-white-50 text-uppercase mb-1">Cache System</div>
                            <div class="h6 mb-0 font-weight-bold">ACTIVE</div>
                        </div>
                        <div>
                            <i class="fas fa-memory fa-2x text-white-300"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex align-items-center justify-content-between">
                    <button class="btn btn-sm btn-light" onclick="clearCache()">Clear Cache</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Maintenance Windows -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Scheduled Maintenance Windows</h6>
        </div>
        <div class="card-body">
            {% if windows %}
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Description</th>
                            <th>Scheduled Start</th>
                            <th>Scheduled End</th>
                            <th>Status</th>
                            <th>Duration</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for window in windows %}
                        <tr class="{{ 'table-warning' if window.status == 'in_progress' else 'table-success' if window.status == 'completed' else '' }}">
                            <td>
                                <strong>{{ window.title }}</strong>
                            </td>
                            <td>
                                <div class="text-truncate" style="max-width: 200px;" title="{{ window.description or 'N/A' }}">
                                    {{ window.description or 'N/A' }}
                                </div>
                            </td>
                            <td>{{ window.scheduled_start.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>{{ window.scheduled_end.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                {% if window.status == 'scheduled' %}
                                    <span class="badge badge-secondary">Scheduled</span>
                                {% elif window.status == 'in_progress' %}
                                    <span class="badge badge-warning">In Progress</span>
                                {% elif window.status == 'completed' %}
                                    <span class="badge badge-success">Completed</span>
                                {% elif window.status == 'cancelled' %}
                                    <span class="badge badge-danger">Cancelled</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if window.actual_start and window.actual_end %}
                                    {{ ((window.actual_end - window.actual_start).total_seconds() / 60)|round|int }} min
                                {% elif window.actual_start %}
                                    {{ ((now() - window.actual_start).total_seconds() / 60)|round|int }} min (ongoing)
                                {% else %}
                                    {{ ((window.scheduled_end - window.scheduled_start).total_seconds() / 60)|round|int }} min (est.)
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    {% if window.status == 'scheduled' %}
                                        <button type="button" class="btn btn-outline-success" 
                                                onclick="activateMaintenanceWindow({{ window.id }})" title="Start Now">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" 
                                                onclick="cancelMaintenanceWindow({{ window.id }})" title="Cancel">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    {% elif window.status == 'in_progress' %}
                                        <button type="button" class="btn btn-outline-primary" 
                                                onclick="completeMaintenanceWindow({{ window.id }})" title="Complete">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    {% endif %}
                                    <button type="button" class="btn btn-outline-info" 
                                            onclick="viewMaintenanceDetails({{ window.id }})" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center">
                <p class="text-muted">No maintenance windows scheduled.</p>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newMaintenanceModal">
                    Schedule First Maintenance Window
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- System Maintenance Tools -->
    <div class="row">
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Database Maintenance</h6>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Optimize Database</h6>
                                <p class="mb-1 text-muted small">Optimize tables and rebuild indexes</p>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="optimizeDatabase()">
                                Optimize
                            </button>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Cleanup Old Data</h6>
                                <p class="mb-1 text-muted small">Remove old logs and temporary data</p>
                            </div>
                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="cleanupOldData()">
                                Cleanup
                            </button>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Vacuum Database</h6>
                                <p class="mb-1 text-muted small">Reclaim storage space</p>
                            </div>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="vacuumDatabase()">
                                Vacuum
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">System Maintenance</h6>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Clear Application Logs</h6>
                                <p class="mb-1 text-muted small">Remove old application log files</p>
                            </div>
                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="clearLogs()">
                                Clear
                            </button>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Restart Application</h6>
                                <p class="mb-1 text-muted small">Restart the application server</p>
                            </div>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="restartApplication()">
                                Restart
                            </button>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Update System Status</h6>
                                <p class="mb-1 text-muted small">Force refresh of system health metrics</p>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="updateSystemStatus()">
                                Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Maintenance Window Modal -->
<div class="modal fade" id="newMaintenanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Schedule Maintenance Window</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="newMaintenanceForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="maintenanceTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="maintenanceTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="maintenanceDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="maintenanceDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="scheduledStart" class="form-label">Start Time</label>
                                <input type="datetime-local" class="form-control" id="scheduledStart" name="scheduled_start" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="scheduledEnd" class="form-label">End Time</label>
                                <input type="datetime-local" class="form-control" id="scheduledEnd" name="scheduled_end" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="enableMaintenanceModeOnStart" name="enable_maintenance_mode">
                            <label class="form-check-label" for="enableMaintenanceModeOnStart">
                                Enable maintenance mode when started
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Schedule Maintenance</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Status Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Operation Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="statusMessage"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Handle new maintenance window form submission
document.getElementById('newMaintenanceForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    fetch('/admin/maintenance/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('newMaintenanceModal')).hide();
            showStatusModal('success', data.message);
            setTimeout(() => location.reload(), 2000);
        } else {
            showStatusModal('error', data.message);
        }
    })
    .catch(error => {
        showStatusModal('error', 'Failed to schedule maintenance window');
    });
});

function enableMaintenanceMode() {
    if (confirm('Are you sure you want to enable maintenance mode? This will block user access to the application.')) {
        showStatusModal('info', 'Enabling maintenance mode...');
        // Implementation would go here
        setTimeout(() => {
            showStatusModal('success', 'Maintenance mode enabled successfully');
            setTimeout(() => location.reload(), 2000);
        }, 1000);
    }
}

function disableMaintenanceMode() {
    if (confirm('Disable maintenance mode and restore normal operation?')) {
        showStatusModal('info', 'Disabling maintenance mode...');
        // Implementation would go here
        setTimeout(() => {
            showStatusModal('success', 'Maintenance mode disabled successfully');
            setTimeout(() => location.reload(), 2000);
        }, 1000);
    }
}

function testDatabase() {
    showStatusModal('info', 'Testing database connection...');
    setTimeout(() => {
        showStatusModal('success', 'Database connection test successful');
    }, 1000);
}

function initiateBackup() {
    if (confirm('Start a full system backup? This may take several minutes.')) {
        showStatusModal('info', 'Starting backup process...');
        // Implementation would go here
        setTimeout(() => {
            showStatusModal('success', 'Backup completed successfully');
        }, 3000);
    }
}

function clearCache() {
    if (confirm('Clear all cached data? This may temporarily slow down the application.')) {
        showStatusModal('info', 'Clearing cache...');
        setTimeout(() => {
            showStatusModal('success', 'Cache cleared successfully');
        }, 1000);
    }
}

function activateMaintenanceWindow(windowId) {
    if (confirm('Start this maintenance window now?')) {
        fetch(`/admin/maintenance/${windowId}/activate`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            showStatusModal(data.success ? 'success' : 'error', data.message);
            if (data.success) {
                setTimeout(() => location.reload(), 2000);
            }
        });
    }
}

function completeMaintenanceWindow(windowId) {
    if (confirm('Complete this maintenance window?')) {
        fetch(`/admin/maintenance/${windowId}/complete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            showStatusModal(data.success ? 'success' : 'error', data.message);
            if (data.success) {
                setTimeout(() => location.reload(), 2000);
            }
        });
    }
}

function cancelMaintenanceWindow(windowId) {
    if (confirm('Cancel this scheduled maintenance window?')) {
        fetch(`/admin/maintenance/${windowId}/cancel`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            showStatusModal(data.success ? 'success' : 'error', data.message);
            if (data.success) {
                setTimeout(() => location.reload(), 2000);
            }
        });
    }
}

function viewMaintenanceDetails(windowId) {
    // Show detailed maintenance window information
    showStatusModal('info', `Maintenance window details would be displayed here for window ID: ${windowId}`);
}

function optimizeDatabase() {
    if (confirm('Optimize the database? This may take several minutes and could affect performance.')) {
        showStatusModal('info', 'Optimizing database...');
        setTimeout(() => {
            showStatusModal('success', 'Database optimization completed');
        }, 5000);
    }
}

function cleanupOldData() {
    if (confirm('Clean up old data? This will permanently remove old logs and temporary files.')) {
        showStatusModal('info', 'Cleaning up old data...');
        setTimeout(() => {
            showStatusModal('success', 'Old data cleanup completed');
        }, 3000);
    }
}

function vacuumDatabase() {
    if (confirm('Vacuum the database? This will reclaim storage space but may take time.')) {
        showStatusModal('info', 'Vacuuming database...');
        setTimeout(() => {
            showStatusModal('success', 'Database vacuum completed');
        }, 4000);
    }
}

function clearLogs() {
    if (confirm('Clear application logs? This will permanently remove log files.')) {
        showStatusModal('info', 'Clearing logs...');
        setTimeout(() => {
            showStatusModal('success', 'Logs cleared successfully');
        }, 1000);
    }
}

function restartApplication() {
    if (confirm('Restart the application? This will temporarily interrupt service.')) {
        showStatusModal('warning', 'Restarting application... Please wait.');
        // In a real implementation, this would trigger an actual restart
        setTimeout(() => {
            showStatusModal('success', 'Application restarted successfully');
        }, 10000);
    }
}

function updateSystemStatus() {
    showStatusModal('info', 'Refreshing system status...');
    setTimeout(() => {
        showStatusModal('success', 'System status updated');
        location.reload();
    }, 2000);
}

function showStatusModal(type, message) {
    const modalElement = document.getElementById('statusModal');
    const messageElement = document.getElementById('statusMessage');
    
    let alertClass = 'alert-info';
    if (type === 'success') alertClass = 'alert-success';
    else if (type === 'error') alertClass = 'alert-danger';
    else if (type === 'warning') alertClass = 'alert-warning';
    
    messageElement.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
    
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
}

// Set default start time to current time + 1 hour
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    now.setHours(now.getHours() + 1);
    document.getElementById('scheduledStart').value = now.toISOString().slice(0, 16);
    
    const endTime = new Date(now);
    endTime.setHours(endTime.getHours() + 2);
    document.getElementById('scheduledEnd').value = endTime.toISOString().slice(0, 16);
});
</script>
{% endblock %}