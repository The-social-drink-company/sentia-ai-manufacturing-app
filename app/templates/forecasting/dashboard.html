{% extends "base.html" %}
{% block title %}Forecasting Dashboard{% endblock %}

{% block extra_head %}
<!-- Plotly for interactive charts -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<!-- Additional styling for forecasting dashboard -->
<style>
    .forecast-control-panel {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
    }
    
    .forecast-chart-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .metric-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .metric-value {
        font-size: 2em;
        font-weight: bold;
        color: #007bff;
        margin-bottom: 5px;
    }
    
    .metric-label {
        color: #6c757d;
        font-size: 0.9em;
    }
    
    .slider-container {
        margin: 15px 0;
    }
    
    .slider-label {
        font-weight: 500;
        margin-bottom: 5px;
        display: block;
    }
    
    .slider-value {
        color: #007bff;
        font-weight: bold;
    }
    
    .algorithm-selector {
        margin: 15px 0;
    }
    
    .forecast-insights {
        background: #e7f3ff;
        border-left: 4px solid #007bff;
        padding: 15px;
        margin: 15px 0;
    }
    
    .accuracy-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
    }
    
    .accuracy-excellent { background-color: #28a745; }
    .accuracy-good { background-color: #ffc107; }
    .accuracy-fair { background-color: #fd7e14; }
    .accuracy-poor { background-color: #dc3545; }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 20px;
    }
    
    .btn-generate {
        background: linear-gradient(45deg, #007bff, #0056b3);
        border: none;
        color: white;
        padding: 10px 30px;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-generate:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,123,255,0.4);
        color: white;
    }
    
    .btn-generate:disabled {
        background: #6c757d;
        transform: none;
        box-shadow: none;
    }
    
    .range-input {
        width: 100%;
        margin: 10px 0;
    }
    
    .confidence-band {
        fill-opacity: 0.2;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-chart-line me-2"></i>
                Demand Forecasting Dashboard
            </h1>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="row">
        <div class="col-12">
            <div class="forecast-control-panel">
                <h4><i class="fas fa-cogs me-2"></i>Forecast Configuration</h4>
                
                <div class="row">
                    <!-- Product and Channel Selection -->
                    <div class="col-md-3">
                        <label for="productSelect" class="form-label">Product</label>
                        <select class="form-select" id="productSelect">
                            <option value="">Select Product...</option>
                            <option value="gaba-red-uk">GABA Red (UK)</option>
                            <option value="gaba-black-uk">GABA Black (UK)</option>
                            <option value="gaba-gold-uk">GABA Gold (UK)</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="channelSelect" class="form-label">Sales Channel</label>
                        <select class="form-select" id="channelSelect">
                            <option value="">Select Channel...</option>
                            <option value="amazon-uk">Amazon UK</option>
                            <option value="shopify-uk">Shopify UK</option>
                            <option value="amazon-usa">Amazon USA</option>
                            <option value="shopify-eu">Shopify EU</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="horizonSlider" class="form-label">Forecast Horizon</label>
                        <input type="range" class="form-range range-input" id="horizonSlider" 
                               min="7" max="90" value="30" step="1">
                        <div class="text-center">
                            <span class="slider-value" id="horizonValue">30</span> days
                        </div>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="algorithmSelect" class="form-label">Algorithm</label>
                        <select class="form-select" id="algorithmSelect">
                            <option value="auto">Auto-Select</option>
                            <option value="moving_average">Moving Average</option>
                            <option value="exponential_smoothing">Exponential Smoothing</option>
                            <option value="arima">ARIMA</option>
                            <option value="linear_regression">Linear Regression</option>
                            <option value="ml_ensemble">ML Ensemble</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button class="btn btn-generate w-100" id="generateBtn" onclick="generateForecast()">
                                <i class="fas fa-magic me-2"></i>Generate Forecast
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Advanced Controls -->
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-outline-secondary btn-sm" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#advancedControls">
                            <i class="fas fa-sliders-h me-1"></i>Advanced Controls
                        </button>
                    </div>
                </div>

                <div class="collapse" id="advancedControls">
                    <div class="row mt-3">
                        <!-- Seasonal Adjustment -->
                        <div class="col-md-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="seasonalSwitch" checked>
                                <label class="form-check-label" for="seasonalSwitch">
                                    Seasonal Adjustment
                                </label>
                            </div>
                        </div>

                        <!-- External Factor Adjustments -->
                        <div class="col-md-3">
                            <label for="promotionSlider" class="slider-label">
                                Promotion Factor: <span class="slider-value" id="promotionValue">1.0</span>
                            </label>
                            <input type="range" class="form-range" id="promotionSlider" 
                                   min="0.5" max="2.0" value="1.0" step="0.1">
                        </div>

                        <div class="col-md-3">
                            <label for="marketSlider" class="slider-label">
                                Market Trend: <span class="slider-value" id="marketValue">0.0</span>%
                            </label>
                            <input type="range" class="form-range" id="marketSlider" 
                                   min="-0.3" max="0.3" value="0.0" step="0.05">
                        </div>

                        <div class="col-md-3">
                            <label for="economicSlider" class="slider-label">
                                Economic Factor: <span class="slider-value" id="economicValue">0.0</span>%
                            </label>
                            <input type="range" class="form-range" id="economicSlider" 
                                   min="-0.2" max="0.2" value="0.0" step="0.02">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Generating forecast...</span>
        </div>
        <p class="mt-2">Generating forecast with advanced algorithms...</p>
    </div>

    <!-- Summary Metrics -->
    <div class="row" id="metricsRow" style="display: none;">
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value" id="totalDemandMetric">-</div>
                <div class="metric-label">Total Forecasted Demand</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value" id="avgDailyMetric">-</div>
                <div class="metric-label">Avg Daily Demand</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value" id="peakDemandMetric">-</div>
                <div class="metric-label">Peak Demand Day</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value" id="accuracyMetric">
                    <span class="accuracy-indicator accuracy-good"></span>-
                </div>
                <div class="metric-label">Model Accuracy</div>
            </div>
        </div>
    </div>

    <!-- Main Forecast Chart -->
    <div class="row">
        <div class="col-12">
            <div class="forecast-chart-container">
                <h5><i class="fas fa-chart-area me-2"></i>Demand Forecast with Confidence Intervals</h5>
                <div id="forecastChart" style="height: 400px;"></div>
            </div>
        </div>
    </div>

    <!-- Secondary Charts -->
    <div class="row">
        <!-- Seasonal Patterns -->
        <div class="col-md-6">
            <div class="forecast-chart-container">
                <h6><i class="fas fa-calendar-alt me-2"></i>Seasonal Pattern Analysis</h6>
                <div id="seasonalChart" style="height: 300px;"></div>
            </div>
        </div>
        
        <!-- Model Comparison -->
        <div class="col-md-6">
            <div class="forecast-chart-container">
                <h6><i class="fas fa-brain me-2"></i>Algorithm Performance</h6>
                <div id="modelComparisonChart" style="height: 300px;"></div>
            </div>
        </div>
    </div>

    <!-- Forecast Insights -->
    <div class="row">
        <div class="col-12">
            <div class="forecast-insights" id="insightsPanel" style="display: none;">
                <h6><i class="fas fa-lightbulb me-2"></i>Forecast Insights & Recommendations</h6>
                <ul id="insightsList"></ul>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row">
        <div class="col-12 text-center">
            <button class="btn btn-success me-2" id="approveForecastBtn" onclick="approveForecast()" 
                    style="display: none;">
                <i class="fas fa-check me-1"></i>Approve Forecast
            </button>
            <button class="btn btn-info me-2" id="exportBtn" onclick="exportForecast()" 
                    style="display: none;">
                <i class="fas fa-download me-1"></i>Export Data
            </button>
            <button class="btn btn-warning" id="optimizeBtn" onclick="optimizeParameters()" 
                    style="display: none;">
                <i class="fas fa-cog me-1"></i>Optimize Parameters
            </button>
        </div>
    </div>
</div>

<script>
// Global variables
let currentForecast = null;
let currentForecastId = null;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeSliders();
    loadProductsAndChannels();
});

function initializeSliders() {
    // Horizon slider
    const horizonSlider = document.getElementById('horizonSlider');
    const horizonValue = document.getElementById('horizonValue');
    horizonSlider.addEventListener('input', function() {
        horizonValue.textContent = this.value;
    });

    // Promotion factor slider
    const promotionSlider = document.getElementById('promotionSlider');
    const promotionValue = document.getElementById('promotionValue');
    promotionSlider.addEventListener('input', function() {
        promotionValue.textContent = parseFloat(this.value).toFixed(1);
    });

    // Market trend slider
    const marketSlider = document.getElementById('marketSlider');
    const marketValue = document.getElementById('marketValue');
    marketSlider.addEventListener('input', function() {
        marketValue.textContent = (parseFloat(this.value) * 100).toFixed(1);
    });

    // Economic factor slider
    const economicSlider = document.getElementById('economicSlider');
    const economicValue = document.getElementById('economicValue');
    economicSlider.addEventListener('input', function() {
        economicValue.textContent = (parseFloat(this.value) * 100).toFixed(1);
    });
}

function loadProductsAndChannels() {
    // In a real implementation, this would load from the API
    console.log('Products and channels loaded');
}

async function generateForecast() {
    const productId = document.getElementById('productSelect').value;
    const channelId = document.getElementById('channelSelect').value;
    const horizon = parseInt(document.getElementById('horizonSlider').value);
    const algorithm = document.getElementById('algorithmSelect').value;
    const seasonal = document.getElementById('seasonalSwitch').checked;
    
    // External factors
    const promotionFactor = parseFloat(document.getElementById('promotionSlider').value);
    const marketTrend = parseFloat(document.getElementById('marketSlider').value);
    const economicFactor = parseFloat(document.getElementById('economicSlider').value);

    if (!productId || !channelId) {
        alert('Please select both product and sales channel');
        return;
    }

    // Show loading
    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('generateBtn').disabled = true;

    try {
        const response = await fetch('/api/forecast/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                product_id: productId,
                sales_channel_id: channelId,
                forecast_horizon: horizon,
                algorithm: algorithm,
                apply_seasonal: seasonal,
                external_factors: {
                    promotion_factor: promotionFactor,
                    market_trend: marketTrend,
                    economic_indicator: economicFactor
                }
            })
        });

        const data = await response.json();
        
        if (data.status === 'success') {
            currentForecast = data.forecast;
            currentForecastId = data.forecast.forecast_id;
            displayForecastResults(data.forecast);
        } else {
            alert('Error generating forecast: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    } finally {
        // Hide loading
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('generateBtn').disabled = false;
    }
}

function displayForecastResults(forecast) {
    // Update metrics
    updateMetrics(forecast);
    
    // Show charts
    plotForecastChart(forecast);
    plotSeasonalChart(forecast);
    plotModelComparison(forecast);
    
    // Show insights
    displayInsights(forecast);
    
    // Show action buttons
    showActionButtons();
    
    // Show metrics row
    document.getElementById('metricsRow').style.display = 'flex';
}

function updateMetrics(forecast) {
    const summary = forecast.summary;
    
    document.getElementById('totalDemandMetric').textContent = 
        Math.round(summary.total_forecasted_demand).toLocaleString();
    
    document.getElementById('avgDailyMetric').textContent = 
        Math.round(summary.average_daily_demand).toLocaleString();
    
    document.getElementById('peakDemandMetric').textContent = 
        `Day ${summary.peak_demand_day}`;
    
    // Model accuracy
    const accuracy = forecast.model_accuracy;
    const mape = accuracy.mape || 0;
    let accuracyClass = 'accuracy-excellent';
    let accuracyText = 'Excellent';
    
    if (mape > 0.5) {
        accuracyClass = 'accuracy-poor';
        accuracyText = 'Poor';
    } else if (mape > 0.2) {
        accuracyClass = 'accuracy-fair';
        accuracyText = 'Fair';
    } else if (mape > 0.1) {
        accuracyClass = 'accuracy-good';
        accuracyText = 'Good';
    }
    
    const accuracyMetric = document.getElementById('accuracyMetric');
    accuracyMetric.innerHTML = 
        `<span class="accuracy-indicator ${accuracyClass}"></span>${accuracyText}`;
}

function plotForecastChart(forecast) {
    const forecasts = forecast.forecasts;
    const lower = forecast.confidence_lower;
    const upper = forecast.confidence_upper;
    
    // Generate date labels
    const dates = [];
    const today = new Date();
    for (let i = 1; i <= forecasts.length; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        dates.push(date.toISOString().split('T')[0]);
    }
    
    const traces = [
        {
            x: dates,
            y: upper,
            fill: 'tonexty',
            fillcolor: 'rgba(0, 123, 255, 0.2)',
            line: { color: 'transparent' },
            name: 'Upper Confidence',
            showlegend: false,
            hovertemplate: 'Upper Bound: %{y}<extra></extra>'
        },
        {
            x: dates,
            y: lower,
            fill: 'tonexty',
            fillcolor: 'rgba(0, 123, 255, 0.2)',
            line: { color: 'transparent' },
            name: 'Lower Confidence',
            showlegend: false,
            hovertemplate: 'Lower Bound: %{y}<extra></extra>'
        },
        {
            x: dates,
            y: forecasts,
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Forecasted Demand',
            line: { color: '#007bff', width: 3 },
            marker: { size: 6, color: '#007bff' },
            hovertemplate: 'Date: %{x}<br>Demand: %{y}<extra></extra>'
        }
    ];
    
    const layout = {
        title: false,
        xaxis: {
            title: 'Date',
            type: 'date'
        },
        yaxis: {
            title: 'Demand (Units)',
            rangemode: 'tozero'
        },
        hovermode: 'x unified',
        legend: {
            orientation: 'h',
            x: 0,
            y: 1.1
        },
        margin: { t: 20, r: 20, b: 60, l: 60 }
    };
    
    Plotly.newPlot('forecastChart', traces, layout, {responsive: true});
}

function plotSeasonalChart(forecast) {
    // Mock seasonal data - in real implementation would come from seasonal_patterns
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const factors = [1.2, 1.4, 1.1, 0.9, 0.8, 0.7, 0.8, 0.9, 1.1, 1.0, 0.8, 0.7];
    
    const trace = {
        x: months,
        y: factors,
        type: 'bar',
        marker: {
            color: factors.map(f => f > 1 ? '#28a745' : '#dc3545'),
            opacity: 0.7
        },
        hovertemplate: 'Month: %{x}<br>Factor: %{y}<extra></extra>'
    };
    
    const layout = {
        title: false,
        xaxis: { title: 'Month' },
        yaxis: { title: 'Seasonal Factor' },
        margin: { t: 20, r: 20, b: 60, l: 60 }
    };
    
    Plotly.newPlot('seasonalChart', [trace], layout, {responsive: true});
}

function plotModelComparison(forecast) {
    // Mock model comparison data
    const models = ['Moving Average', 'Exp. Smoothing', 'ARIMA', 'ML Ensemble'];
    const accuracy = [0.75, 0.82, 0.78, 0.85];
    const colors = ['#17a2b8', '#28a745', '#ffc107', '#007bff'];
    
    const trace = {
        x: models,
        y: accuracy,
        type: 'bar',
        marker: {
            color: colors,
            opacity: 0.8
        },
        hovertemplate: 'Model: %{x}<br>Accuracy: %{y}<extra></extra>'
    };
    
    const layout = {
        title: false,
        xaxis: { title: 'Algorithm' },
        yaxis: { 
            title: 'Accuracy Score',
            range: [0, 1]
        },
        margin: { t: 20, r: 20, b: 80, l: 60 }
    };
    
    Plotly.newPlot('modelComparisonChart', [trace], layout, {responsive: true});
}

function displayInsights(forecast) {
    const insights = forecast.insights || [];
    const insightsList = document.getElementById('insightsList');
    
    insightsList.innerHTML = '';
    insights.forEach(insight => {
        const li = document.createElement('li');
        li.textContent = insight;
        insightsList.appendChild(li);
    });
    
    document.getElementById('insightsPanel').style.display = 'block';
}

function showActionButtons() {
    document.getElementById('approveForecastBtn').style.display = 'inline-block';
    document.getElementById('exportBtn').style.display = 'inline-block';
    document.getElementById('optimizeBtn').style.display = 'inline-block';
}

async function approveForecast() {
    if (!currentForecastId) {
        alert('No forecast to approve');
        return;
    }

    try {
        const response = await fetch(`/api/forecast/${currentForecastId}/approve`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();
        
        if (data.status === 'success') {
            alert('Forecast approved successfully!');
        } else {
            alert('Error approving forecast: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

function exportForecast() {
    if (!currentForecast) {
        alert('No forecast data to export');
        return;
    }

    // Create CSV content
    let csvContent = "Date,Forecasted_Demand,Lower_Confidence,Upper_Confidence\n";
    
    const today = new Date();
    currentForecast.forecasts.forEach((forecast, index) => {
        const date = new Date(today);
        date.setDate(today.getDate() + index + 1);
        csvContent += `${date.toISOString().split('T')[0]},${forecast},${currentForecast.confidence_lower[index]},${currentForecast.confidence_upper[index]}\n`;
    });

    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `forecast_${currentForecast.product_id}_${Date.now()}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

async function optimizeParameters() {
    const productId = document.getElementById('productSelect').value;
    const channelId = document.getElementById('channelSelect').value;
    
    if (!productId || !channelId) {
        alert('Please select product and channel first');
        return;
    }

    try {
        const response = await fetch('/api/forecast/optimize-parameters', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                product_id: productId,
                sales_channel_id: channelId
            })
        });

        const data = await response.json();
        
        if (data.status === 'success') {
            const optimization = data.optimization;
            const bestParams = optimization.optimized_parameters;
            
            // Apply optimized parameters to UI
            document.getElementById('algorithmSelect').value = bestParams.algorithm;
            document.getElementById('horizonSlider').value = bestParams.horizon;
            document.getElementById('horizonValue').textContent = bestParams.horizon;
            document.getElementById('seasonalSwitch').checked = bestParams.seasonal_adjustment;
            
            alert(`Parameters optimized! Best algorithm: ${bestParams.algorithm}, Expected accuracy: ${(bestParams.expected_accuracy * 100).toFixed(1)}%`);
        } else {
            alert('Error optimizing parameters: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}
</script>
{% endblock %}